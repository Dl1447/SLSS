<!DOCTYPE html>
<!-- 
Student Learning Situation Statistics (SLSS)

A lightweight classroom management web application for tracking student performance,
homework submission status, and course evaluations.

Copyright (c) 2025 Alan ab
Licensed under the MIT License
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3B82F6">
    <meta name="description" content="轻量级课堂统计管理Web应用">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="bjbz.png">
    <title>初一二班学情统计</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        light: '#F3F4F6',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'shine': 'shine 2s infinite',
                        'glass-flow': 'glassFlow 8s ease-in-out infinite alternate'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shine: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        },
                        glassFlow: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '100%': { backgroundPosition: '100% 50%' }
                        }
                    }
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .star-active {
                color: #F59E0B;
            }
            .star-inactive {
                color: #D1D5DB;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            }
            .glass-effect-dark {
                background: rgba(30, 41, 59, 0.7);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            }
            .gradient-border {
                position: relative;
                border-radius: 12px;
                z-index: 0;
            }
            .gradient-border::before {
                content: '';
                position: absolute;
                inset: -2px;
                z-index: -1;
                border-radius: 14px;
                background: linear-gradient(90deg, #3B82F6, #8B5CF6, #10B981, #F59E0B);
                background-size: 400% 400%;
                animation: gradient-animation 15s ease infinite;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .gradient-border:hover::before {
                opacity: 1;
            }
            .hover-lift {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .hover-lift:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px -8px rgba(59, 130, 246, 0.15);
            }
            .text-gradient {
                background: linear-gradient(90deg, #3B82F6, #8B5CF6);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
            }
            .shine-effect {
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
                background-size: 200% 100%;
            }
        }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    
    <div class="fixed inset-0 -z-10 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-blue-100 via-transparent to-purple-100 opacity-70"></div>
    <div class="fixed inset-0 -z-20 bg-[radial-gradient(ellipse_at_bottom_left,_var(--tw-gradient-stops))] from-indigo-100 via-transparent to-blue-100 opacity-70"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <header class="mb-8 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-xl overflow-hidden glass-effect flex items-center justify-center hover-lift transition-all duration-300">
                    <img src="bjbz.png" alt="班级Logo" class="w-12 h-12 object-contain">
                </div>
                <div>
                    <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-gradient mb-2 animate-pulse-slow">初一二班学情统计</h1>
                    <p id="class-motto" class="text-accent italic"></p>
                </div>
            </div>
        </header>

        <div class="glass-effect rounded-2xl shadow-xl overflow-hidden mb-8 hover-lift">
            
            <div class="p-5 flex justify-between items-center border-b border-white/20">
                <div class="flex items-center gap-3">
                    <i class="fa fa-calendar text-primary text-2xl animate-pulse-slow"></i>
                    <h2 id="current-date" class="text-2xl font-semibold text-dark"></h2>
                </div>
                <button id="export-excel" class="gradient-border bg-primary hover:bg-primary/90 text-white px-5 py-2.5 rounded-lg transition-all duration-300 flex items-center gap-2 hover:shadow-lg">
                    <i class="fa fa-download"></i>
                    <span>导出Excel</span>
                </button>
            </div>

            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 p-8">
                
                <div class="lg:col-span-1">
                    <div class="glass-effect rounded-xl p-6 h-full hover-lift">
                        <h3 class="text-xl font-semibold mb-5 text-dark flex items-center gap-2">
                            <i class="fa fa-exclamation-circle text-warning"></i>
                            未交作业记录
                        </h3>
                        
                        <div class="space-y-6">
                            
                            <div class="mb-6">
                                <label for="subject-select" class="block text-sm font-medium text-gray-700 mb-2">选择科目</label>
                                <select id="subject-select" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                    <!-- 科目将通过JavaScript动态生成 -->
                                </select>
                            </div>
                            
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">选择未交作业学生学号</label>
                                <div id="student-numbers" class="flex flex-wrap gap-2 max-h-64 overflow-y-auto scrollbar-hide p-3 glass-effect border border-white/30 rounded-xl">
                                    
                                </div>
                            </div>
                            
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">已选学号</label>
                                <div id="selected-numbers" class="flex flex-wrap gap-2 p-4 glass-effect border border-white/30 rounded-xl min-h-[80px] transition-all duration-300"></div>
                            </div>
                            
                            
                            <button id="add-homework-record" class="w-full gradient-border bg-secondary hover:bg-secondary/90 text-white py-3 rounded-xl transition-all duration-300 hover:shadow-lg mb-6">
                                添加未交作业记录
                            </button>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">已记录列表</label>
                                <div id="homework-records" class="space-y-3 max-h-64 overflow-y-auto scrollbar-hide p-3 glass-effect border border-white/30 rounded-xl"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-xl p-6 h-full hover-lift">
                        <h3 class="text-xl font-semibold mb-5 text-dark flex items-center gap-2">
                            <i class="fa fa-book text-primary animate-pulse-slow"></i>
                            课程表现评分
                        </h3>
                        
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">选择星期</label>
                            <div class="flex flex-wrap gap-2">
                                <button class="day-btn gradient-border bg-primary text-white px-5 py-3 rounded-xl transition-all duration-300 hover:shadow-lg" data-day="周一">周一</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周二">周二</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周三">周三</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周四">周四</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周五">周五</button>
                            </div>
                        </div>
                        
                        
                        <div class="mb-4">
                            <button id="add-new-course" class="gradient-border bg-secondary hover:bg-secondary/90 text-white px-5 py-3 rounded-xl transition-all duration-300 hover:shadow-lg flex items-center gap-2">
                                <i class="fa fa-plus"></i>
                                <span>添加新课</span>
                            </button>
                        </div>
                        
                        
                        <div id="schedule-container" class="space-y-3 max-h-[calc(100vh-350px)] overflow-y-auto scrollbar-hide pb-2">
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <footer class="text-center text-gray-500 text-sm mt-12">
            <p>GlidePlum &copy; 2025 Alan ab</p>
        </footer>
    </div>

    <script>
        // 初始化变量
        let currentDay = "周一";
        let selectedStudentNumbers = [];
        let scheduleData = {
            "周一": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周二": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周三": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周四": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周五": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周六": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周日": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] }))
        };
        let homeworkRecords = [];
        
        // 班级配置 - 可自定义
        let classConfig = {
            minStudentId: 1,
            maxStudentId: 50,
            excludedIds: [21, 22, 23, 24, 25, 26, 27, 28, 29,30], // 排除的学号
            subjects: ["语文", "数学", "英语", "物理", "化学", "生物", "历史", "地理", "政治"],
            gradeSubjects: {
                "初一": ["语文", "数学", "英语", "历史", "地理", "政治"],
                "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治"],
                "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治"]
            },
            classInfo: {
                name: "初一二班",
                grade: "初一",
                motto: "团结拼搏，追求卓越"
            }
        };
        
        // IndexedDB 数据库
        const DB_NAME = 'slss-database';
        const DB_VERSION = 4; // 更新版本号以匹配现有数据库
        let db = null;
        
        // 初始化 IndexedDB
        function initDatabase() {
            return new Promise((resolve, reject) => {
                if (db) {
                    resolve(db);
                    return;
                }
                
                try {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onerror = () => {
                        console.error('数据库打开失败:', request.error);
                        // 即使数据库失败，也返回resolve以便应用继续运行
                        resolve(null);
                    };
                    
                    request.onsuccess = () => {
                        db = request.result;
                        console.log('数据库打开成功');
                        resolve(db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        
                        // 创建或更新课程表数据存储
                        if (!db.objectStoreNames.contains('schedule')) {
                            db.createObjectStore('schedule', { keyPath: 'day' });
                        }
                        
                        // 创建或更新作业记录数据存储
                        if (!db.objectStoreNames.contains('homework')) {
                            const homeworkStore = db.createObjectStore('homework', { keyPath: 'id' });
                            if (!homeworkStore.indexNames.contains('by-date')) {
                                homeworkStore.createIndex('by-date', 'date', { unique: false });
                            }
                            if (!homeworkStore.indexNames.contains('by-subject')) {
                                homeworkStore.createIndex('by-subject', 'subject', { unique: false });
                            }
                        }
                        
                        // 创建或更新配置存储
                        if (!db.objectStoreNames.contains('config')) {
                            const configStore = db.createObjectStore('config', { keyPath: 'id' });
                            // 存储默认配置
                            configStore.put({ 
                                id: 'class-config', 
                                data: {
                                    minStudentId: 1,
                                    maxStudentId: 50,
                                    excludedIds: [21, 22, 23, 24, 25, 26, 27, 28, 29],
                                    subjects: ["语文", "数学", "英语", "历史", "地理", "政治"],
                                    gradeSubjects: {
                                        "初一": ["语文", "数学", "英语", "历史", "地理", "政治"],
                                        "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治"],
                                        "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治"]
                                    },
                                    classInfo: {
                                    name: "初一二班",
                                    grade: "初一",
                                    motto: "团结拼搏，追求卓越"
                                }
                                }
                            });
                        }
                    };
                } catch (error) {
                    console.error('数据库初始化异常:', error);
                    resolve(null);
                }
            });
        }
        
        // 保存班级配置
        function saveClassConfig() {
            if (!db) return;
            
            const transaction = db.transaction(['config'], 'readwrite');
            const store = transaction.objectStore('config');
            store.put({ id: 'class-config', data: classConfig });
            
            transaction.oncomplete = () => {
                console.log('班级配置保存成功');
            };
        }
        
        // 加载班级配置
        function loadClassConfig() {
            return new Promise((resolve) => {
                // 确保gradeSubjects配置始终存在
                if (!classConfig.gradeSubjects) {
                    classConfig.gradeSubjects = {
                        "初一": ["语文", "数学", "英语", "历史", "地理", "政治"],
                        "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治"],
                        "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治"]
                    };
                }
                
                try {
                    if (!db) {
                        // 数据库不可用时，确保学科列表正确
                        ensureSubjectsBasedOnGrade();
                        resolve(classConfig);
                        return;
                    }
                    
                    const transaction = db.transaction(['config'], 'readonly');
                    const store = transaction.objectStore('config');
                    const request = store.get('class-config');
                    
                    request.onsuccess = () => {
                        if (request.result && request.result.data) {
                            classConfig = request.result.data;
                            // 确保gradeSubjects配置存在
                            if (!classConfig.gradeSubjects) {
                                classConfig.gradeSubjects = {
                                    "初一": ["语文", "数学", "英语", "历史", "地理", "政治"],
                                    "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治"],
                                    "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治"]
                                };
                            }
                            // 确保学科列表基于年级正确设置
                            ensureSubjectsBasedOnGrade();
                        } else {
                            // 没有配置数据时，确保学科列表正确
                            ensureSubjectsBasedOnGrade();
                        }
                        // 更新页面标题和班训
                document.querySelector('h1').textContent = `${classConfig.classInfo.name}学情统计`;
                updateClassMotto();
                resolve(classConfig);
                    };
                    
                    request.onerror = () => {
                        console.error('加载班级配置失败');
                        // 出错时确保学科列表正确
                        ensureSubjectsBasedOnGrade();
                        resolve(classConfig);
                    };
                } catch (error) {
                    console.error('加载班级配置异常:', error);
                    // 异常时确保学科列表正确
                    ensureSubjectsBasedOnGrade();
                    resolve(classConfig);
                }
            });
        }
        
        // 确保学科列表基于年级正确设置
        function ensureSubjectsBasedOnGrade() {
            const grade = classConfig.classInfo.grade;
            if (!grade) {
                // 如果没有年级设置，默认使用初一
                classConfig.classInfo.grade = "初一";
                classConfig.subjects = [...classConfig.gradeSubjects["初一"]];
            } else if (classConfig.gradeSubjects[grade]) {
                // 如果是预设年级，关联对应学科
                classConfig.subjects = [...classConfig.gradeSubjects[grade]];
            } else {
                // 自定义年级使用默认基础学科
                classConfig.subjects = ['语文', '数学', '英语'];
            }
        }
        
        // 生成科目选择器
        function generateSubjectSelect() {
            const select = document.getElementById('subject-select');
            select.innerHTML = '';
            
            classConfig.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                select.appendChild(option);
            });
        }
        
        // 添加配置和导入功能
        function addConfigAndImportFeatures() {
            // 添加配置按钮到头部
            const header = document.querySelector('header');
            const configBtn = document.createElement('button');
            configBtn.id = 'config-btn';
            configBtn.className = 'gradient-border bg-accent hover:bg-accent/90 text-white px-5 py-2.5 rounded-lg transition-all duration-300 flex items-center gap-2 hover:shadow-lg';
            configBtn.innerHTML = '<i class="fa fa-cog"></i><span>配置</span>';
            header.appendChild(configBtn);
            
            // 添加导入按钮
            const exportBtn = document.getElementById('export-excel');
            const importBtn = document.createElement('button');
            importBtn.id = 'import-data';
            importBtn.className = 'gradient-border bg-secondary hover:bg-secondary/90 text-white px-5 py-2.5 rounded-lg transition-all duration-300 flex items-center gap-2 hover:shadow-lg ml-3';
            importBtn.innerHTML = '<i class="fa fa-upload"></i><span>导入数据</span>';
            exportBtn.parentNode.appendChild(importBtn);
            
            // 创建隐藏的文件输入
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            fileInput.id = 'file-import';
            document.body.appendChild(fileInput);
            
            // 绑定导入按钮事件
            importBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 处理文件导入
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // 验证导入的数据结构
                        if (importedData.homeworkRecords) {
                            homeworkRecords = importedData.homeworkRecords;
                            displayHomeworkRecords();
                            saveHomeworkRecords();
                        }
                        
                        if (importedData.scheduleData) {
                            scheduleData = importedData.scheduleData;
                            generateSchedule();
                            saveScheduleData();
                        }
                        
                        if (importedData.classConfig) {
                            classConfig = importedData.classConfig;
                            generateSubjectSelect();
                            generateStudentNumberButtons();
                            saveClassConfig();
                            // 更新页面标题
                            document.querySelector('h1').textContent = `${classConfig.classInfo.name}学情统计`;
                        }
                        
                        alert('数据导入成功！');
                    } catch (error) {
                        alert('数据导入失败：文件格式错误或内容无效');
                    }
                    
                    // 重置文件输入
                    this.value = '';
                };
                reader.readAsText(file);
            });
            
            // 绑定配置按钮事件
            configBtn.addEventListener('click', openConfigModal);
            
            // 创建配置模态框
            createConfigModal();
        }
        
        // 创建配置模态框
        function createConfigModal() {
            const modal = document.createElement('div');
            modal.id = 'config-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-white/20">
                        <h2 class="text-2xl font-bold text-dark flex items-center gap-2">
                            <i class="fa fa-cog text-accent"></i>
                            班级配置
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <h3 class="font-medium text-dark mb-3">班级信息</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">班级名称</label>
                                    <input id="config-class-name" type="text" value="${classConfig.classInfo.name}" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">年级（将自动关联对应学科）</label>
                                    <select id="config-grade" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                        <option value="初一" ${classConfig.classInfo.grade === "初一" ? 'selected' : ''}>初一</option>
                                        <option value="初二" ${classConfig.classInfo.grade === "初二" ? 'selected' : ''}>初二</option>
                                        <option value="初三" ${classConfig.classInfo.grade === "初三" ? 'selected' : ''}>初三</option>
                                        <option value="自定义" ${!['初一', '初二', '初三'].includes(classConfig.classInfo.grade) ? 'selected' : ''}>自定义</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">班训</label>
                                <input id="config-class-motto" type="text" value="${classConfig.classInfo.motto || ''}" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" placeholder="输入班级班训">
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">学号范围</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">最小学号</label>
                                    <input id="config-min-id" type="number" value="${classConfig.minStudentId}" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">最大学号</label>
                                    <input id="config-max-id" type="number" value="${classConfig.maxStudentId}" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">排除的学号</h3>
                            <input id="config-excluded-ids" type="text" value="${classConfig.excludedIds.join(', ')}" placeholder="用逗号分隔，如：21, 22, 23" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                        </div>
                        

                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">课程设置</h3>
                            <label class="block text-sm font-medium text-gray-700 mb-2">每天课程节数</label>
                            <input id="config-max-sections" type="number" min="1" max="20" value="8" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">数据管理</h3>
                            <div class="space-y-3">
                                <button id="export-all-data" class="w-full gradient-border bg-primary hover:bg-primary/90 text-white py-3 rounded-xl transition-all duration-300 hover:shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa fa-download"></i>
                                    <span>导出所有数据</span>
                                </button>
                                <button id="reset-all-data" class="w-full gradient-border bg-danger hover:bg-danger/90 text-white py-3 rounded-xl transition-all duration-300 hover:shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa fa-refresh"></i>
                                    <span>重置所有数据</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 border-t border-white/20 flex justify-end gap-3">
                        <button id="cancel-config" class="px-5 py-2.5 glass-effect border border-white/30 rounded-lg hover:bg-gray-100/50 transition-all duration-300">取消</button>
                        <button id="save-config" class="px-5 py-2.5 gradient-border bg-accent hover:bg-accent/90 text-white rounded-lg transition-all duration-300 hover:shadow-lg">保存配置</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定模态框事件
            document.getElementById('cancel-config').addEventListener('click', closeConfigModal);
            document.getElementById('save-config').addEventListener('click', saveConfigChanges);
            document.getElementById('export-all-data').addEventListener('click', exportAllData);
            document.getElementById('reset-all-data').addEventListener('click', resetAllData);
        }
        
        // 打开配置模态框
        function openConfigModal() {
            document.getElementById('config-modal').classList.remove('hidden');
            // 防止背景滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭配置模态框
        function closeConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
            // 恢复背景滚动
            document.body.style.overflow = '';
        }
        
        // 保存配置更改
        function saveConfigChanges() {
            try {
                classConfig.classInfo.name = document.getElementById('config-class-name').value || '班级';
                classConfig.classInfo.motto = document.getElementById('config-class-motto').value || '';
                const selectedGrade = document.getElementById('config-grade').value;
                
                // 如果选择了预设年级，自动关联对应学科
                if (selectedGrade !== '自定义' && classConfig.gradeSubjects[selectedGrade]) {
                    classConfig.classInfo.grade = selectedGrade;
                    classConfig.subjects = [...classConfig.gradeSubjects[selectedGrade]]; // 复制预设学科列表
                } else {
                    classConfig.classInfo.grade = '自定义';
                    // 对于自定义年级，使用默认的基础学科
                    classConfig.subjects = ['语文', '数学', '英语'];
                }
                
                classConfig.minStudentId = parseInt(document.getElementById('config-min-id').value) || 1;
                classConfig.maxStudentId = parseInt(document.getElementById('config-max-id').value) || 50;
                classConfig.maxClassSections = parseInt(document.getElementById('config-max-sections').value) || 8;
                
                // 解析排除的学号
                const excludedIdsStr = document.getElementById('config-excluded-ids').value;
                classConfig.excludedIds = excludedIdsStr ? excludedIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id)) : [];
                
                // 验证课程节数
                if (classConfig.maxClassSections < 1 || classConfig.maxClassSections > 20) {
                    alert('课程节数必须在1-20之间！');
                    return;
                }
                
                // 验证配置
                if (classConfig.minStudentId > classConfig.maxStudentId) {
                    alert('最小学号不能大于最大学号！');
                    return;
                }
                
                // 保存配置
                saveClassConfig();
                
                // 更新UI
                generateSubjectSelect();
                generateStudentNumberButtons();
                document.querySelector('h1').textContent = `${classConfig.classInfo.name}学情统计`;
                updateClassMotto();
                
                closeConfigModal();
                alert('配置保存成功！');
            } catch (error) {
                alert('配置保存失败：' + error.message);
            }
        }
        
        // 导出所有数据
        function exportAllData() {
            const allData = {
                classConfig: classConfig,
                scheduleData: scheduleData,
                homeworkRecords: homeworkRecords,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `SLSS_数据导出_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // 重置所有数据
        function resetAllData() {
            if (!confirm('确定要重置所有数据吗？此操作不可撤销！')) {
                return;
            }
            
            // 重置数据
            const maxSections = classConfig.maxClassSections || 8;
            scheduleData = {
                "周一": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                "周二": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                "周三": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                "周四": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                "周五": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                "周六": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                "周日": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] }))
            };
            homeworkRecords = [];
            selectedStudentNumbers = [];
            
            // 更新UI
            generateSchedule();
            displayHomeworkRecords();
            updateSelectedNumbersDisplay();
            
            // 保存到数据库
            saveScheduleData();
            saveHomeworkRecords();
            
            alert('所有数据已重置！');
        }
        
        // 保存课程表数据到 IndexedDB
        function saveScheduleData() {
            if (!db) return;
            
            const transaction = db.transaction(['schedule'], 'readwrite');
            const store = transaction.objectStore('schedule');
            
            Object.keys(scheduleData).forEach(day => {
                store.put({ day: day, courses: scheduleData[day] });
            });
            
            transaction.oncomplete = () => {
                console.log('课程表数据保存成功');
            };
            
            transaction.onerror = () => {
                console.error('课程表数据保存失败');
            };
        }
        
        // 从 IndexedDB 加载课程表数据
        function loadScheduleData() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(scheduleData);
                    return;
                }
                
                const transaction = db.transaction(['schedule'], 'readonly');
                const store = transaction.objectStore('schedule');
                const allRequest = store.getAll();
                
                allRequest.onsuccess = () => {
                    const data = allRequest.result;
                    if (data.length > 0) {
                        data.forEach(item => {
                            if (scheduleData.hasOwnProperty(item.day)) {
                                scheduleData[item.day] = item.courses || [];
                            }
                        });
                    }
                    resolve(scheduleData);
                };
                
                allRequest.onerror = () => {
                    console.error('加载课程表数据失败');
                    resolve(scheduleData);
                };
            });
        }
        
        // 保存作业记录到 IndexedDB
        function saveHomeworkRecords() {
            if (!db) return;
            
            const transaction = db.transaction(['homework'], 'readwrite');
            const store = transaction.objectStore('homework');
            
            homeworkRecords.forEach(record => {
                store.put(record);
            });
            
            transaction.oncomplete = () => {
                console.log('作业记录保存成功');
            };
            
            transaction.onerror = () => {
                console.error('作业记录保存失败');
            };
        }
        
        // 从 IndexedDB 加载作业记录
        function loadHomeworkRecords() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(homeworkRecords);
                    return;
                }
                
                const transaction = db.transaction(['homework'], 'readonly');
                const store = transaction.objectStore('homework');
                const allRequest = store.getAll();
                
                allRequest.onsuccess = () => {
                    homeworkRecords = allRequest.result;
                    resolve(homeworkRecords);
                };
                
                allRequest.onerror = () => {
                    console.error('加载作业记录失败');
                    resolve(homeworkRecords);
                };
            });
        }
        
        // 创建并显示加载动画
        function showLoader() {
            // 检查加载器是否已存在
            let loader = document.getElementById('page-loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'page-loader';
                loader.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center';
                loader.innerHTML = `
                    <div class="glass-effect p-8 rounded-2xl flex flex-col items-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary mb-4"></div>
                        <p id="loader-text" class="text-white text-lg">加载中...</p>
                    </div>
                `;
                document.body.appendChild(loader);
            }
            loader.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // 隐藏加载动画
        function hideLoader() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // 更新加载动画文本
        function updateLoaderText(text) {
            const loaderText = document.getElementById('loader-text');
            if (loaderText) {
                loaderText.textContent = text;
            }
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', async function() {
            // 显示加载动画
            showLoader();
            
            try {
                // 设置当前日期
                updateCurrentDate();
                
                // 确保classConfig包含gradeSubjects配置
                if (!classConfig.gradeSubjects) {
                    classConfig.gradeSubjects = {
                        "初一": ["语文", "数学", "英语", "历史", "地理", "政治"],
                        "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治"],
                        "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治"]
                    };
                }
                
                // 如果没有选择年级，默认使用初一
                if (!classConfig.classInfo.grade) {
                    classConfig.classInfo.grade = "初一";
                    classConfig.subjects = [...classConfig.gradeSubjects["初一"]];
                }
                
                // 更新加载状态
                updateLoaderText('加载数据中...');
                
                // 初始化数据库并加载数据（容错处理）
                try {
                    await initDatabase();
                    // 尝试加载数据，但即使失败也继续
                    try { await loadScheduleData(); } catch (e) { console.error('加载课程表失败:', e); }
                    try { await loadHomeworkRecords(); } catch (e) { console.error('加载作业记录失败:', e); }
                    try { await loadClassConfig(); } catch (e) { console.error('加载班级配置失败:', e); }
                } catch (error) {
                    console.error('数据库初始化失败:', error);
                    // 即使数据库失败，也继续初始化应用
                }
                
                // 更新加载状态
                updateLoaderText('生成界面元素...');
                
                // 生成科目选择器
                generateSubjectSelect();
                
                // 生成学号选择器
                generateStudentNumberButtons();
                
                // 更新班训显示
                updateClassMotto();
                
                // 生成课程表
                generateSchedule();
                
                // 显示作业记录
                displayHomeworkRecords();
                
                // 绑定事件监听器
                bindEventListeners();
                
                // 添加配置按钮和导入功能
                addConfigAndImportFeatures();
                
                // 注册Service Worker
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('service-worker.js')
                            .then(registration => {
                                console.log('Service Worker 注册成功:', registration.scope);
                            })
                            .catch(error => {
                                console.log('Service Worker 注册失败:', error);
                            });
                    });
                }
            } catch (error) {
                console.error('初始化失败:', error);
            } finally {
                // 隐藏加载动画
                setTimeout(() => {
                    hideLoader();
                }, 500); // 短暂延迟，确保用户能看到加载过程
            }
        });
        
        // 更新当前日期
        // 更新班训显示
function updateClassMotto() {
    const mottoElement = document.getElementById('class-motto');
    if (mottoElement && classConfig.classInfo.motto) {
        mottoElement.textContent = classConfig.classInfo.motto;
    }
}

function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', options);
        }
        
        // 生成学号选择器
        function generateStudentNumberButtons() {
            // 查找或创建批量操作按钮容器
            let batchContainer = document.getElementById('batch-controls-container');
            if (!batchContainer) {
                batchContainer = document.createElement('div');
                batchContainer.id = 'batch-controls-container';
                batchContainer.className = 'mb-6';
                
                // 将批量操作容器插入到学号选择器之前
                const container = document.getElementById('student-numbers');
                container.parentNode.insertBefore(batchContainer, container);
            }
            
            // 设置批量操作按钮
            batchContainer.innerHTML = `
                <div class="flex gap-3 p-4 glass-effect border border-white/20 rounded-xl">
                    <button id="select-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                        全选
                    </button>
                    <button id="select-range-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                        选择范围
                    </button>
                    <button id="clear-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                        清空选择
                    </button>
                </div>
            `;
            
            // 绑定批量操作事件
            document.getElementById('select-all-btn').addEventListener('click', selectAllStudents);
            document.getElementById('select-range-btn').addEventListener('click', selectStudentRange);
            document.getElementById('clear-all-btn').addEventListener('click', clearAllStudentSelections);
            
            // 清空并生成学号按钮
            const container = document.getElementById('student-numbers');
            container.innerHTML = '';
            
            // 根据配置生成学号按钮
            for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                // 跳过排除的学号
                if (classConfig.excludedIds.includes(i)) continue;
                
                const button = document.createElement('button');
                button.className = 'student-number-btn w-12 h-12 flex items-center justify-center rounded-full glass-effect border border-white/30 hover:bg-primary/10 transition-all duration-300 hover-lift';
                button.textContent = i;
                button.dataset.number = i;
                
                button.addEventListener('click', function() {
                    toggleStudentNumber(i);
                });
                
                container.appendChild(button);
            }
        }
        
        // 批量操作函数
        function selectAllStudents() {
            selectedStudentNumbers = [];
            
            for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                if (!classConfig.excludedIds.includes(i)) {
                    selectedStudentNumbers.push(i);
                }
            }
            
            updateStudentNumberButtons();
            updateSelectedNumbersDisplay();
        }
        
        function selectStudentRange() {
            const rangeInput = prompt('请输入学号范围（格式：开始-结束，如 1-10）：');
            if (!rangeInput) return;
            
            const [start, end] = rangeInput.split('-').map(Number);
            if (isNaN(start) || isNaN(end) || start > end) {
                alert('请输入有效的范围格式！');
                return;
            }
            
            // 验证范围在有效范围内
            if (start < classConfig.minStudentId || end > classConfig.maxStudentId) {
                alert(`范围必须在 ${classConfig.minStudentId}-${classConfig.maxStudentId} 之间！`);
                return;
            }
            
            // 添加范围内的学号
            for (let i = start; i <= end; i++) {
                if (!classConfig.excludedIds.includes(i) && !selectedStudentNumbers.includes(i)) {
                    selectedStudentNumbers.push(i);
                }
            }
            
            updateStudentNumberButtons();
            updateSelectedNumbersDisplay();
        }
        
        function clearAllStudentSelections() {
            selectedStudentNumbers = [];
            updateStudentNumberButtons();
            updateSelectedNumbersDisplay();
        }
        
        function updateStudentNumberButtons() {
            document.querySelectorAll('.student-number-btn').forEach(button => {
                const number = parseInt(button.dataset.number);
                if (selectedStudentNumbers.includes(number)) {
                    button.classList.add('bg-primary/20', 'border-primary');
                } else {
                    button.classList.remove('bg-primary/20', 'border-primary');
                }
            });
        }
        
        // 切换学号选择状态
        function toggleStudentNumber(number) {
            const index = selectedStudentNumbers.indexOf(number);
            const button = document.querySelector(`.student-number-btn[data-number="${number}"]`);
            
            if (index === -1) {
                selectedStudentNumbers.push(number);
                if (button) button.classList.add('bg-primary/20', 'border-primary');
            } else {
                selectedStudentNumbers.splice(index, 1);
                if (button) button.classList.remove('bg-primary/20', 'border-primary');
            }
            
            updateSelectedNumbersDisplay();
        }
        
        // 更新已选学号显示
        function updateSelectedNumbersDisplay() {
            const container = document.getElementById('selected-numbers');
            container.innerHTML = '';
            
            selectedStudentNumbers.sort((a, b) => a - b).forEach(number => {
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center glass-effect border border-white/30 bg-primary/20 text-primary px-3 py-1.5 rounded-full text-sm hover-lift transition-all duration-300';
                tag.innerHTML = `${number} <span class="ml-1 cursor-pointer remove-number">&times;</span>`;
                tag.dataset.number = number;
                
                const removeBtn = tag.querySelector('.remove-number');
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleStudentNumber(number);
                });
                
                container.appendChild(tag);
            });
            
            if (selectedStudentNumbers.length === 0) {
                container.innerHTML = '<span class="text-gray-400">暂无选择</span>';
            }
        }
        
        // 生成课程表
        function generateSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            
            const courses = scheduleData[currentDay];
            courses.forEach(course => {
                container.appendChild(createCourseItem(course));
            });
        }
        
        // 编辑课程节数
        function editSectionNumber(courseId) {
            const newNumber = prompt('请输入新的课程节数:', courseId);
            if (newNumber === null) return;
            
            const number = parseInt(newNumber);
            if (isNaN(number) || number < 1 || number > 99) {
                alert('请输入有效的课程节数（1-99）！');
                return;
            }
            
            // 检查是否重复
            const courses = scheduleData[currentDay];
            if (courses.some(c => c.id !== courseId && c.id === number)) {
                alert('该课程节数已存在！');
                return;
            }
            
            // 更新课程节数
            const course = courses.find(c => c.id === courseId);
            if (course) {
                course.id = number;
                saveScheduleData();
                generateSchedule();
            }
        }
        
        // 创建课程项
        function createCourseItem(course) {
            const courseDiv = document.createElement('div');
            courseDiv.className = 'glass-effect rounded-xl p-5 shadow-sm border border-white/30 hover-lift transition-all duration-300 relative';
            courseDiv.innerHTML = `
                <div class="flex items-center mb-4">
                    <span class="section-number bg-primary/20 text-primary font-semibold rounded-full w-10 h-10 flex items-center justify-center mr-4 hover-lift transition-all duration-300 cursor-pointer" data-id="${course.id}" title="点击修改课程节数">${course.id}</span>
                    <input type="text" placeholder="请输入科目名称" value="${course.subject || ''}" 
                           class="flex-1 px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                           data-field="subject" data-id="${course.id}">
                </div>
                <button class="absolute top-4 right-4 text-gray-400 hover:text-danger transition-colors delete-course-btn" data-id="${course.id}">
                    <i class="fa fa-trash"></i>
                </button>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">课堂表现评分</label>
                    <!-- 快速选择科目 -->
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${classConfig.subjects.map(subject => `
                            <button class="quick-subject-btn px-3 py-1 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-subject="${subject}">
                                ${subject}
                            </button>
                        `).join('')}
                    </div>
                    <!-- 评分显示，根据科目类型显示不同的评分方式 -->
                    <div class="space-y-3" data-field="rating" data-id="${course.id}">
                        ${course.subject === '数学' || course.subject === '英语' ? `
                            <!-- 分层班评分 - 三行显示 -->
                            <div class="flex items-center">
                                <span class="w-8 text-sm text-gray-500">1班:</span>
                                <div class="flex-1 flex gap-1">
                                    ${Array(5).fill(null).map((_, i) => {
                                        const starIndex = i + 1;
                                        return `<i class="fa fa-star text-sm cursor-pointer transition-transform hover:scale-110 ${starIndex <= (course.layerRatings?.layer1 || 0) ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}" data-layer="1"></i>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="w-8 text-sm text-gray-500">2班:</span>
                                <div class="flex-1 flex gap-1">
                                    ${Array(5).fill(null).map((_, i) => {
                                        const starIndex = i + 1;
                                        return `<i class="fa fa-star text-sm cursor-pointer transition-transform hover:scale-110 ${starIndex <= (course.layerRatings?.layer2 || 0) ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}" data-layer="2"></i>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="w-8 text-sm text-gray-500">3班:</span>
                                <div class="flex-1 flex gap-1">
                                    ${Array(5).fill(null).map((_, i) => {
                                        const starIndex = i + 1;
                                        return `<i class="fa fa-star text-sm cursor-pointer transition-transform hover:scale-110 ${starIndex <= (course.layerRatings?.layer3 || 0) ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}" data-layer="3"></i>`;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <!-- 普通评分 -->
                            <div class="flex gap-2">
                                ${Array(5).fill(null).map((_, i) => {
                                    const starIndex = i + 1;
                                    return `<i class="fa fa-star text-lg cursor-pointer transition-transform hover:scale-110 ${starIndex <= course.rating ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}"></i>`;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- 课堂不足及建议 - 根据科目类型显示不同 -->
                <div>
                    ${course.subject === '数学' || course.subject === '英语' ? `
                        <!-- 分层班的课堂不足及建议 -->
                        <label class="block text-sm font-medium text-gray-700 mb-2">课堂不足及建议</label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">1班：</label>
                                <textarea placeholder="请输入1班课堂不足及建议" rows="2" 
                                          class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                          data-field="notes" data-id="${course.id}" data-layer="1">${course.layerNotes?.layer1 || ''}</textarea>
                                <!-- 1班快速选择理由 -->
                                <div class="mt-2">
                                    <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话" data-layer="1">上课说话</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉" data-layer="1">睡觉</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记" data-layer="1">不记笔记</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中" data-layer="1">注意力不集中</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序" data-layer="1">扰乱课堂秩序</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">2班：</label>
                                <textarea placeholder="请输入2班课堂不足及建议" rows="2" 
                                          class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                          data-field="notes" data-id="${course.id}" data-layer="2">${course.layerNotes?.layer2 || ''}</textarea>
                                <!-- 2班快速选择理由 -->
                                <div class="mt-2">
                                    <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话" data-layer="2">上课说话</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉" data-layer="2">睡觉</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记" data-layer="2">不记笔记</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中" data-layer="2">注意力不集中</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序" data-layer="2">扰乱课堂秩序</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">3班：</label>
                                <textarea placeholder="请输入3班课堂不足及建议" rows="2" 
                                          class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                          data-field="notes" data-id="${course.id}" data-layer="3">${course.layerNotes?.layer3 || ''}</textarea>
                                <!-- 3班快速选择理由 -->
                                <div class="mt-2">
                                    <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话" data-layer="3">上课说话</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉" data-layer="3">睡觉</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记" data-layer="3">不记笔记</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中" data-layer="3">注意力不集中</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序" data-layer="3">扰乱课堂秩序</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <!-- 普通课堂不足及建议 -->
                        <label class="block text-sm font-medium text-gray-700 mb-2">课堂不足及建议</label>
                        <textarea placeholder="请输入课堂不足及建议" rows="2" 
                                  class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                  data-field="notes" data-id="${course.id}">${course.notes || ''}</textarea>
                        <!-- 快速选择理由 -->
                        <div class="mt-2">
                            <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                            <div class="flex flex-wrap gap-2">
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话">上课说话</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉">睡觉</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记">不记笔记</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中">注意力不集中</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序">扰乱课堂秩序</button>
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- 快速选择学号功能 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">表现不佳学生</label>
                    <div class="mb-2">
                        <div id="course-students-${course.id}" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto scrollbar-hide p-2 glass-effect border border-white/30 rounded-lg min-h-[60px]">
                            ${course.poorStudents ? course.poorStudents.map(num => `
                                <div class="inline-flex items-center glass-effect border border-white/30 bg-danger/20 text-danger px-2 py-1 rounded-full text-xs hover-lift transition-all duration-300">
                                    ${num} <span class="ml-1 cursor-pointer remove-poor-student" data-number="${num}">&times;</span>
                                </div>
                            `).join('') : '<span class="text-gray-400 text-xs">暂无选择</span>'}
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="quick-select-students-btn px-3 py-1 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}">
                            <i class="fa fa-user-o mr-1"></i>选择学生
                        </button>
                    </div>
                </div>`;
            
            // 绑定科目输入事件
            const subjectInput = courseDiv.querySelector('[data-field="subject"]');
            subjectInput.addEventListener('input', function() {
                updateCourseData(course.id, 'subject', this.value);
            });
            
            // 绑定快速选择科目事件
            const quickSubjectBtns = courseDiv.querySelectorAll('.quick-subject-btn');
            quickSubjectBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const courseId = parseInt(this.dataset.id);
                    const subject = this.dataset.subject;
                    
                    // 更新科目
                    updateCourseData(courseId, 'subject', subject);
                    
                    // 更新UI中的科目输入框
                    const subjectInput = courseDiv.querySelector('[data-field="subject"]');
                    if (subjectInput) {
                        subjectInput.value = subject;
                    }
                    
                    // 添加点击动画效果
                    this.classList.add('bg-primary/20');
                    setTimeout(() => {
                        this.classList.remove('bg-primary/20');
                    }, 300);
                    
                    // 重新生成课程表以更新评分显示
                    setTimeout(() => {
                        generateSchedule();
                    }, 50);
                });
            });
            
            // 绑定评分点击事件
            const ratingContainer = courseDiv.querySelector('[data-field="rating"]');
            const stars = ratingContainer.querySelectorAll('.fa-star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    
                    // 检查是否有分层信息
                    if (this.dataset.layer) {
                        // 分层评分逻辑
                        const layer = this.dataset.layer;
                        const courseId = parseInt(ratingContainer.dataset.id);
                        const course = scheduleData[currentDay].find(c => c.id === courseId);
                        
                        // 确保layerRatings对象存在
                        if (!course.layerRatings) {
                            course.layerRatings = { layer1: 0, layer2: 0, layer3: 0 };
                        }
                        
                        // 更新对应分层的评分
                        course.layerRatings[`layer${layer}`] = rating;
                        
                        // 保存数据
                        saveScheduleData();
                        
                        // 更新UI
                        generateSchedule();
                    } else {
                        // 普通评分逻辑
                        updateCourseData(course.id, 'rating', rating);
                        updateStarDisplay(stars, rating);
                    }
                    
                    // 添加点击动画效果
                    this.classList.add('animate-pulse');
                    setTimeout(() => {
                        this.classList.remove('animate-pulse');
                    }, 500);
                });
                
                // 添加悬停效果
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    
                    if (this.dataset.layer) {
                        // 分层评分悬停效果
                        const layer = this.dataset.layer;
                        const layerStars = ratingContainer.querySelectorAll(`[data-layer="${layer}"]`);
                        layerStars.forEach(s => {
                            const sRating = parseInt(s.dataset.rating);
                            if (sRating <= rating) {
                                s.classList.add('scale-125');
                            }
                        });
                    } else {
                        // 普通评分悬停效果
                        stars.forEach(s => {
                            const sRating = parseInt(s.dataset.rating);
                            if (sRating <= rating) {
                                s.classList.add('scale-125');
                            }
                        });
                    }
                });
                
                star.addEventListener('mouseleave', function() {
                    if (this.dataset.layer) {
                        // 分层评分恢复
                        const layer = this.dataset.layer;
                        const layerStars = ratingContainer.querySelectorAll(`[data-layer="${layer}"]`);
                        layerStars.forEach(s => {
                            s.classList.remove('scale-125');
                        });
                    } else {
                        // 普通评分恢复
                        stars.forEach(s => {
                            s.classList.remove('scale-125');
                        });
                    }
                });
            });
            
            // 绑定笔记输入事件 - 同时处理普通笔记和分层笔记
            const notesInputs = courseDiv.querySelectorAll('[data-field="notes"]');
            notesInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const courseId = parseInt(this.dataset.id);
                    const layer = this.dataset.layer;
                    const course = scheduleData[currentDay].find(c => c.id === courseId);
                    
                    if (layer) {
                        // 分层笔记处理
                        if (!course.layerNotes) {
                            course.layerNotes = { layer1: '', layer2: '', layer3: '' };
                        }
                        course.layerNotes[`layer${layer}`] = this.value;
                        saveScheduleData();
                    } else {
                        // 普通笔记处理
                        updateCourseData(course.id, 'notes', this.value);
                    }
                });
            });
            
            // 绑定删除按钮事件
            const deleteBtn = courseDiv.querySelector('.delete-course-btn');
            deleteBtn.addEventListener('click', function() {
                const courseId = parseInt(this.dataset.id);
                deleteCourse(courseId);
            });
            
            // 绑定选择学生按钮事件
            const selectStudentsBtn = courseDiv.querySelector('.quick-select-students-btn');
            selectStudentsBtn.addEventListener('click', function() {
                const courseId = parseInt(this.dataset.id);
                showStudentSelectionModal(courseId);
            });
            
            // 绑定快速选择理由事件
            const quickReasonBtns = courseDiv.querySelectorAll('.quick-reason-btn');
            quickReasonBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const courseId = parseInt(this.dataset.id);
                    const reason = this.dataset.reason;
                    handleQuickReason(courseId, reason);
                });
            });
            
            // 绑定已选学生移除按钮事件
            const removeButtons = courseDiv.querySelectorAll('.remove-poor-student');
            removeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const number = parseInt(this.dataset.number);
                    removePoorStudent(course.id, number);
                });
            });
            
            // 绑定课程节数编辑事件
            const sectionNumberEl = courseDiv.querySelector('.section-number');
            sectionNumberEl.addEventListener('click', function() {
                const courseId = parseInt(this.dataset.id);
                editSectionNumber(courseId);
            });
            
            return courseDiv;
        }
        
        // 更新课程数据
        function updateCourseData(courseId, field, value) {
            const courseIndex = scheduleData[currentDay].findIndex(c => c.id === courseId);
            if (courseIndex !== -1) {
                scheduleData[currentDay][courseIndex][field] = value;
                // 自动保存到 IndexedDB
                saveScheduleData();
            }
        }
        
        // 更新表现不佳学生列表
        function updatePoorStudents(courseId, students) {
            const courseIndex = scheduleData[currentDay].findIndex(c => c.id === courseId);
            if (courseIndex !== -1) {
                scheduleData[currentDay][courseIndex].poorStudents = students;
                // 自动保存到 IndexedDB
                saveScheduleData();
            }
        }
        
        // 创建学生选择模态框
        function createStudentSelectionModal() {
            const modal = document.createElement('div');
            modal.id = 'student-selection-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-white/20">
                        <h2 class="text-2xl font-bold text-dark flex items-center gap-2">
                            <i class="fa fa-users text-primary"></i>
                            选择表现不佳学生
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">选择学号</label>
                            <div id="modal-student-numbers" class="flex flex-wrap gap-2 max-h-64 overflow-y-auto scrollbar-hide p-3 glass-effect border border-white/30 rounded-xl"></div>
                        </div>
                        
                        <div class="flex gap-3 p-4 glass-effect border border-white/20 rounded-xl">
                            <button id="modal-select-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                                全选
                            </button>
                            <button id="modal-select-range-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                                选择范围
                            </button>
                            <button id="modal-clear-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                                清空选择
                            </button>
                        </div>
                    </div>
                    <div class="p-6 border-t border-white/20 flex justify-end gap-3">
                        <button id="modal-cancel" class="px-5 py-2.5 glass-effect border border-white/30 rounded-lg hover:bg-gray-100/50 transition-all duration-300">取消</button>
                        <button id="modal-confirm" class="px-5 py-2.5 gradient-border bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-300 hover:shadow-lg">确认选择</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 显示学生选择模态框
        function showStudentSelectionModal(courseId) {
            const modal = document.getElementById('student-selection-modal');
            if (!modal) {
                createStudentSelectionModal();
                bindStudentSelectionModalEvents();
            }
            
            // 保存当前课程ID
            modal.dataset.courseId = courseId;
            
            // 获取当前课程的表现不佳学生列表
            const course = scheduleData[currentDay].find(c => c.id === courseId);
            const currentPoorStudents = course ? course.poorStudents : [];
            
            // 生成学号选择按钮
            const container = document.getElementById('modal-student-numbers');
            container.innerHTML = '';
            
            // 根据配置生成学号按钮
            for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                // 跳过排除的学号
                if (classConfig.excludedIds.includes(i)) continue;
                
                const button = document.createElement('button');
                button.className = 'student-number-btn w-10 h-10 flex items-center justify-center rounded-full glass-effect border border-white/30 hover:bg-primary/10 transition-all duration-300 hover-lift';
                button.textContent = i;
                button.dataset.number = i;
                
                // 如果已经在表现不佳学生列表中，标记为选中
                if (currentPoorStudents.includes(i)) {
                    button.classList.add('bg-primary/20', 'border-primary');
                }
                
                button.addEventListener('click', function() {
                    const number = parseInt(this.dataset.number);
                    const index = currentPoorStudents.indexOf(number);
                    
                    if (index === -1) {
                        currentPoorStudents.push(number);
                        this.classList.add('bg-primary/20', 'border-primary');
                    } else {
                        currentPoorStudents.splice(index, 1);
                        this.classList.remove('bg-primary/20', 'border-primary');
                    }
                });
                
                container.appendChild(button);
            }
            
            // 显示模态框
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭学生选择模态框
        function closeStudentSelectionModal() {
            const modal = document.getElementById('student-selection-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }
        
        // 绑定学生选择模态框事件
        function bindStudentSelectionModalEvents() {
            const modal = document.getElementById('student-selection-modal');
            if (!modal) return;
            
            // 取消按钮
            document.getElementById('modal-cancel').addEventListener('click', closeStudentSelectionModal);
            
            // 确认按钮
            document.getElementById('modal-confirm').addEventListener('click', function() {
                const courseId = parseInt(modal.dataset.courseId);
                const course = scheduleData[currentDay].find(c => c.id === courseId);
                
                if (course) {
                    // 更新课程的表现不佳学生列表
                    updatePoorStudents(courseId, course.poorStudents.sort((a, b) => a - b));
                    
                    // 更新UI显示
                    const container = document.getElementById(`course-students-${courseId}`);
                    if (container) {
                        if (course.poorStudents.length === 0) {
                            container.innerHTML = '<span class="text-gray-400 text-xs">暂无选择</span>';
                        } else {
                            container.innerHTML = course.poorStudents.map(num => `
                                <div class="inline-flex items-center glass-effect border border-white/30 bg-danger/20 text-danger px-2 py-1 rounded-full text-xs hover-lift transition-all duration-300">
                                    ${num} <span class="ml-1 cursor-pointer remove-poor-student" data-number="${num}" data-id="${courseId}">&times;</span>
                                </div>
                            `).join('');
                            
                            // 绑定移除按钮事件
                            container.querySelectorAll('.remove-poor-student').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const number = parseInt(this.dataset.number);
                                    const courseId = parseInt(this.dataset.id);
                                    removePoorStudent(courseId, number);
                                });
                            });
                        }
                    }
                }
                
                closeStudentSelectionModal();
            });
            
            // 模态框批量操作按钮
            document.getElementById('modal-select-all-btn').addEventListener('click', function() {
                const courseId = parseInt(modal.dataset.courseId);
                const course = scheduleData[currentDay].find(c => c.id === courseId);
                if (course) {
                    course.poorStudents = [];
                    
                    for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                        if (!classConfig.excludedIds.includes(i)) {
                            course.poorStudents.push(i);
                        }
                    }
                    
                    // 更新UI
                    updateModalStudentButtons(course.poorStudents);
                }
            });
            
            document.getElementById('modal-select-range-btn').addEventListener('click', function() {
                const courseId = parseInt(modal.dataset.courseId);
                const course = scheduleData[currentDay].find(c => c.id === courseId);
                if (course) {
                    const rangeInput = prompt('请输入学号范围（格式：开始-结束，如 1-10）：');
                    if (!rangeInput) return;
                    
                    const [start, end] = rangeInput.split('-').map(Number);
                    if (isNaN(start) || isNaN(end) || start > end) {
                        alert('请输入有效的范围格式！');
                        return;
                    }
                    
                    // 验证范围在有效范围内
                    if (start < classConfig.minStudentId || end > classConfig.maxStudentId) {
                        alert(`范围必须在 ${classConfig.minStudentId}-${classConfig.maxStudentId} 之间！`);
                        return;
                    }
                    
                    // 添加范围内的学号
                    for (let i = start; i <= end; i++) {
                        if (!classConfig.excludedIds.includes(i) && !course.poorStudents.includes(i)) {
                            course.poorStudents.push(i);
                        }
                    }
                    
                    // 更新UI
                    updateModalStudentButtons(course.poorStudents);
                }
            });
            
            document.getElementById('modal-clear-all-btn').addEventListener('click', function() {
                const courseId = parseInt(modal.dataset.courseId);
                const course = scheduleData[currentDay].find(c => c.id === courseId);
                if (course) {
                    course.poorStudents = [];
                    // 更新UI
                    updateModalStudentButtons([]);
                }
            });
        }
        
        // 更新模态框中的学号按钮状态
        function updateModalStudentButtons(selectedNumbers) {
            document.querySelectorAll('#modal-student-numbers .student-number-btn').forEach(button => {
                const number = parseInt(button.dataset.number);
                if (selectedNumbers.includes(number)) {
                    button.classList.add('bg-primary/20', 'border-primary');
                } else {
                    button.classList.remove('bg-primary/20', 'border-primary');
                }
            });
        }
        
        // 移除表现不佳学生
        function removePoorStudent(courseId, number) {
            const course = scheduleData[currentDay].find(c => c.id === courseId);
            if (course) {
                const index = course.poorStudents.indexOf(number);
                if (index !== -1) {
                    course.poorStudents.splice(index, 1);
                    updatePoorStudents(courseId, course.poorStudents);
                    
                    // 更新UI
                    const container = document.getElementById(`course-students-${courseId}`);
                    if (container) {
                        if (course.poorStudents.length === 0) {
                            container.innerHTML = '<span class="text-gray-400 text-xs">暂无选择</span>';
                        } else {
                            container.innerHTML = course.poorStudents.map(num => `
                                <div class="inline-flex items-center glass-effect border border-white/30 bg-danger/20 text-danger px-2 py-1 rounded-full text-xs hover-lift transition-all duration-300">
                                    ${num} <span class="ml-1 cursor-pointer remove-poor-student" data-number="${num}" data-id="${courseId}">&times;</span>
                                </div>
                            `).join('');
                            
                            // 重新绑定移除按钮事件
                            container.querySelectorAll('.remove-poor-student').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const number = parseInt(this.dataset.number);
                                    const courseId = parseInt(this.dataset.id);
                                    removePoorStudent(courseId, number);
                                });
                            });
                        }
                    }
                }
            }
        }
        
        // 处理快速选择理由
        function handleQuickReason(courseId, reason) {
            // 获取触发事件的按钮，从中获取layer信息
            const event = window.event;
            const reasonBtn = event ? event.currentTarget : document.querySelector(`.quick-reason-btn[data-id="${courseId}"][data-reason="${reason}"]`);
            const layer = reasonBtn ? reasonBtn.dataset.layer : '1'; // 默认使用1班
            const layerKey = `layer${layer}`;
            
            const course = scheduleData[currentDay].find(c => c.id === courseId);
            if (course) {
                // 检查是否是分层科目（数学或英语）
                if (course.subject === '数学' || course.subject === '英语') {
                    // 分层科目 - 根据data-layer属性确定班级
                    if (!course.layerNotes) {
                        course.layerNotes = { layer1: '', layer2: '', layer3: '' };
                    }
                    
                    let newNote = course.layerNotes[layerKey] || '';
                    if (newNote) {
                        if (!newNote.includes(reason)) {
                            newNote += '，' + reason;
                        }
                    } else {
                        newNote = reason;
                    }
                    
                    course.layerNotes[layerKey] = newNote;
                    saveScheduleData();
                    
                    // 更新UI
                    const notesInput = document.querySelector(`textarea[data-field="notes"][data-id="${courseId}"][data-layer="${layer}"]`);
                    if (notesInput) {
                        notesInput.value = newNote;
                    }
                } else {
                    // 普通科目处理
                    let newNotes = course.notes || '';
                    if (newNotes) {
                        // 检查是否已经包含该理由
                        if (!newNotes.includes(reason)) {
                            newNotes += '，' + reason;
                        }
                    } else {
                        newNotes = reason;
                    }
                    
                    // 更新备注
                    updateCourseData(courseId, 'notes', newNotes);
                    
                    // 更新UI
                    const notesInput = document.querySelector(`textarea[data-field="notes"][data-id="${courseId}"]:not([data-layer])`);
                    if (notesInput) {
                        notesInput.value = newNotes;
                    }
                }
                
                // 添加点击动画效果
                if (reasonBtn) {
                    reasonBtn.classList.add('bg-primary/20');
                    setTimeout(() => {
                        reasonBtn.classList.remove('bg-primary/20');
                    }, 300);
                }
            }
        }
        
        // 更新星星显示
        function updateStarDisplay(stars, rating) {
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                if (starRating <= rating) {
                    star.classList.add('star-active');
                    star.classList.remove('star-inactive');
                } else {
                    star.classList.remove('star-active');
                    star.classList.add('star-inactive');
                }
            });
        }
        
        // 添加新课程
        function addNewCourse() {
            // 获取当前星期的课程数据
            const courses = scheduleData[currentDay];
            
            // 计算新课程的ID（当前最大ID + 1）
            const maxId = courses.length > 0 ? Math.max(...courses.map(c => c.id)) : 0;
            const newCourse = { id: maxId + 1, subject: '', rating: 0, notes: '' };
            
            // 添加新课程到数据中
            courses.push(newCourse);
            
            // 更新课程表显示
            generateSchedule();
            
            // 为了更好的用户体验，滚动到最后添加的课程
            const container = document.getElementById('schedule-container');
            container.scrollTop = container.scrollHeight;
            
            // 高亮显示新添加的课程（添加一个临时动画效果）
            setTimeout(() => {
                const newCourseElement = container.lastElementChild;
                if (newCourseElement) {
                    newCourseElement.classList.add('bg-primary/10');
                    setTimeout(() => {
                        newCourseElement.classList.remove('bg-primary/10');
                    }, 2000);
                }
            }, 100);
        }
        
        // 删除课程
        function deleteCourse(courseId) {
            // 确认删除操作
            if (!confirm('确定要删除这节课吗？')) {
                return;
            }
            
            // 获取当前星期的课程数据
            const courses = scheduleData[currentDay];
            
            // 找到要删除的课程索引
            const courseIndex = courses.findIndex(c => c.id === courseId);
            
            if (courseIndex !== -1) {
                // 获取要删除的元素进行动画效果
                const container = document.getElementById('schedule-container');
                const courseElements = container.querySelectorAll('.glass-effect.rounded-xl.p-5');
                const elementToDelete = courseElements[courseIndex];
                
                if (elementToDelete) {
                    // 添加删除动画
                    elementToDelete.style.transition = 'all 0.3s ease';
                    elementToDelete.style.opacity = '0';
                    elementToDelete.style.transform = 'translateX(20px)';
                    elementToDelete.style.height = elementToDelete.offsetHeight + 'px';
                }
                
                // 从数据中删除课程
                setTimeout(() => {
                    courses.splice(courseIndex, 1);
                    
                    // 重新生成课程表
                    generateSchedule();
                }, 300);
            }
        }
        
        // 绑定事件监听器
        function bindEventListeners() {
            // 星期切换按钮
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.day-btn').forEach(b => {
                        b.classList.remove('gradient-border', 'bg-primary', 'text-white');
                        b.classList.add('glass-effect', 'border', 'border-white/30', 'hover:bg-primary/10');
                    });
                    
                    this.classList.add('gradient-border', 'bg-primary', 'text-white');
                    this.classList.remove('glass-effect', 'border', 'border-white/30', 'hover:bg-primary/10');
                    
                    // 添加切换动画效果
                    const container = document.getElementById('schedule-container');
                    container.style.opacity = '0';
                    container.style.transform = 'translateY(20px)';
                    container.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    
                    setTimeout(() => {
                        generateSchedule();
                        container.style.opacity = '1';
                        container.style.transform = 'translateY(0)';
                    }, 150);
                    
                    currentDay = this.dataset.day;
                    generateSchedule();
                });
            });
            
            // 添加未交作业记录
            document.getElementById('add-homework-record').addEventListener('click', function() {
                const subject = document.getElementById('subject-select').value;
                if (selectedStudentNumbers.length === 0) {
                    alert('请至少选择一名未交作业的学生');
                    return;
                }
                
                const record = {
                    id: Date.now(),
                    subject: subject,
                    students: [...selectedStudentNumbers],
                    date: new Date().toLocaleDateString('zh-CN')
                };
                
                homeworkRecords.push(record);
                displayHomeworkRecords();
                // 保存到 IndexedDB
                saveHomeworkRecords();
                
                // 清空选择
                selectedStudentNumbers.forEach(number => {
                    const button = document.querySelector(`.student-number-btn[data-number="${number}"]`);
                    if (button) button.classList.remove('bg-primary/20', 'border-primary');
                });
                selectedStudentNumbers = [];
                updateSelectedNumbersDisplay();
            });
            
            // 导出Excel
            document.getElementById('export-excel').addEventListener('click', function() {
                // 添加点击动画效果
                this.classList.add('animate-pulse');
                setTimeout(() => {
                    this.classList.remove('animate-pulse');
                    exportToExcel();
                }, 300);
            });
            
            // 添加滚动时的视差效果
            window.addEventListener('scroll', function() {
                const scrollY = window.scrollY;
                const header = document.querySelector('header');
                header.style.transform = `translateY(${scrollY * 0.1}px)`;
            });
            
            // 添加新课按钮事件
            document.getElementById('add-new-course').addEventListener('click', function() {
                // 添加点击动画效果
                this.classList.add('animate-pulse');
                setTimeout(() => {
                    this.classList.remove('animate-pulse');
                    addNewCourse();
                }, 300);
            });
        }
        
        // 显示未交作业记录
        function displayHomeworkRecords() {
            const container = document.getElementById('homework-records');
            container.innerHTML = '';
            
            homeworkRecords.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'glass-effect p-4 rounded-xl shadow-sm border border-white/30 relative hover-lift transition-all duration-300';
                recordDiv.innerHTML = `
                    <div class="text-sm text-gray-500">${record.date}</div>
                    <div class="font-medium text-dark">${record.subject}</div>
                    <div class="text-sm">未交学号: ${record.students.sort((a, b) => a - b).join(', ')}</div>
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-danger transition-colors delete-record" data-id="${record.id}">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                const deleteBtn = recordDiv.querySelector('.delete-record');
                deleteBtn.addEventListener('click', function() {
                    const recordId = parseInt(this.dataset.id);
                    homeworkRecords = homeworkRecords.filter(r => r.id !== recordId);
                displayHomeworkRecords();
                // 保存到 IndexedDB
                saveHomeworkRecords();
                });
                
                container.appendChild(recordDiv);
            });
            
            if (homeworkRecords.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无记录</div>';
            }
        }
        
        // 导出Excel
        function exportToExcel() {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 准备课程数据
            const scheduleDataForExcel = [];
            Object.keys(scheduleData).forEach(day => {
                scheduleData[day].forEach(course => {
                    if (course.subject) { // 只导出有数据的课程
                        // 检查是否是分层科目（数学或英语）
                        if (course.subject === '数学' || course.subject === '英语') {
                            // 为每个分层单独创建一行数据
                            for (let layer = 1; layer <= 3; layer++) {
                                const layerKey = `layer${layer}`;
                                scheduleDataForExcel.push({
                                    '星期': day,
                                    '课时': course.id,
                                    '科目': `${course.subject}(${layer}班)`,
                                    '评分': course.layerRatings?.[layerKey] || 0,
                                    '课堂不足及建议': course.layerNotes?.[layerKey] || '',
                                    '表现不佳学生学号': course.poorStudents?.join(', ') || ''
                                });
                            }
                        } else {
                            // 普通科目保持原有逻辑
                            scheduleDataForExcel.push({
                                '星期': day,
                                '课时': course.id,
                                '科目': course.subject,
                                '评分': course.rating,
                                '课堂不足及建议': course.notes,
                                '表现不佳学生学号': course.poorStudents?.join(', ') || ''
                            });
                        }
                    }
                });
            });
            
            // 准备未交作业数据
            const homeworkDataForExcel = [];
            homeworkRecords.forEach(record => {
                record.students.forEach(student => {
                    homeworkDataForExcel.push({
                        '日期': record.date,
                        '科目': record.subject,
                        '未交学号': student
                    });
                });
            });
            
            // 创建工作表
            if (scheduleDataForExcel.length > 0) {
                const wsSchedule = XLSX.utils.json_to_sheet(scheduleDataForExcel);
                XLSX.utils.book_append_sheet(wb, wsSchedule, '课程表现');
            }
            
            if (homeworkDataForExcel.length > 0) {
                const wsHomework = XLSX.utils.json_to_sheet(homeworkDataForExcel);
                XLSX.utils.book_append_sheet(wb, wsHomework, '未交作业记录');
            }
            
            // 导出文件
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `班级统计_${dateStr}.xlsx`);
        }
    </script>
</body>
</html>

