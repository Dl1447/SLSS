<!DOCTYPE html>
<!-- 
Student Learning Situation Statistics (SLSS)

A lightweight classroom management web application for tracking student performance,
homework submission status, and course evaluations.

Copyright (c) 2025 All_lan
Licensed under the MIT License
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3B82F6">
    <meta name="description" content="轻量级课堂统计管理Web应用">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="bjbz.png">
    <title>学情统计</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                    secondary: '#10B981',
                    accent: '#8B5CF6',
                    warning: '#F59E0B',
                    danger: '#EF4444',
                    light: '#F3F4F6',
                    dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'shine': 'shine 2s infinite',
                        'glass-flow': 'glassFlow 8s ease-in-out infinite alternate'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        shine: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        },
                        glassFlow: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '100%': { backgroundPosition: '100% 50%' }
                        }
                    }
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {                -ms-overflow-style: none;                scrollbar-width: none;            }
            .ios-scrollbar::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .ios-scrollbar::-webkit-scrollbar-track {
                background: transparent;
            }
            .ios-scrollbar::-webkit-scrollbar-thumb {
                background: rgba(156, 163, 175, 0.5);
                border-radius: 3px;
                transition: background 0.3s ease;
            }
            .ios-scrollbar::-webkit-scrollbar-thumb:hover {
                background: rgba(156, 163, 175, 0.8);
            }
            .ios-scrollbar {
                scrollbar-width: thin;
                scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
            }
            .star-active {
                color: #F59E0B;
            }
            .star-inactive {
                color: #D1D5DB;
            }
            .glass-effect {
                background: rgba(255, 255, 255, 0.7);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            }
            .glass-effect-dark {
                background: rgba(30, 41, 59, 0.7);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border: 1px solid rgba(255, 255, 255, 0.1);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15);
            }
            .gradient-border {
                position: relative;
                border-radius: 12px;
                z-index: 0;
            }
            .gradient-border::before {
                content: '';
                position: absolute;
                inset: -2px;
                z-index: -1;
                border-radius: 14px;
                background: linear-gradient(90deg, #3B82F6, #8B5CF6, #10B981, #F59E0B);
                background-size: 400% 400%;
                animation: gradient-animation 15s ease infinite;
                opacity: 0;
                transition: opacity 0.3s ease;
            }
            .gradient-border:hover::before {
                opacity: 1;
            }
            .hover-lift {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .hover-lift:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 24px -8px rgba(59, 130, 246, 0.15);
            }
            .text-gradient {
                background: linear-gradient(90deg, #3B82F6, #8B5CF6);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
            }
            .shine-effect {
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.5), transparent);
                background-size: 200% 100%;
            }
        }
        
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    
    <div class="fixed inset-0 -z-10 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-blue-100 via-transparent to-purple-100 opacity-70"></div>
    <div class="fixed inset-0 -z-20 bg-[radial-gradient(ellipse_at_bottom_left,_var(--tw-gradient-stops))] from-indigo-100 via-transparent to-blue-100 opacity-70"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <header class="mb-8 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-16 h-16 rounded-xl overflow-hidden glass-effect flex items-center justify-center hover-lift transition-all duration-300">
                    <img src="bjbz.png" alt="班级Logo" class="w-12 h-12 object-contain">
                </div>
                <div>
                    <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-gradient mb-2 animate-pulse-slow">初一二班学情统计</h1>
                    <p id="class-motto" class="text-accent italic"></p>
                </div>
            </div>
        </header>

        <div class="glass-effect rounded-2xl shadow-xl overflow-hidden mb-8 hover-lift">
            
            <div class="p-5 flex justify-between items-center border-b border-white/20">
                <div class="flex items-center gap-3">
                    <i class="fa fa-calendar text-primary text-2xl animate-pulse-slow"></i>
                    <h2 id="current-date" class="text-2xl font-semibold text-dark"></h2>
                </div>
                <button id="export-excel" class="gradient-border bg-primary hover:bg-primary/90 text-white px-5 py-2.5 rounded-lg transition-all duration-300 flex items-center gap-2 hover:shadow-lg">
                    <i class="fa fa-download"></i>
                    <span>导出Excel</span>
                </button>
            </div>

            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 p-8">
                
                <div class="lg:col-span-1">
                    <div class="glass-effect rounded-xl p-6 h-full hover-lift">
                        <h3 class="text-xl font-semibold mb-5 text-dark flex items-center gap-2">
                            <i class="fa fa-exclamation-circle text-warning"></i>
                            未交作业记录
                        </h3>
                        
                        <div class="space-y-6">
                            
                            <div class="mb-6">
                                <label for="subject-select-btn" class="block text-sm font-medium text-gray-700 mb-2">选择科目</label>
                                <div class="relative">
                                    <button id="subject-select-btn" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300 text-left flex justify-between items-center">
                                        <span id="selected-subject-text">请选择科目</span>
                                        <i class="fa fa-chevron-down text-gray-500"></i>
                                    </button>
                                </div>
                            </div>
                            
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">选择未交作业学生学号</label>
                                <div id="student-numbers" class="flex flex-wrap gap-2 max-h-64 overflow-y-auto scrollbar-hide p-3 glass-effect border border-white/30 rounded-xl">
                                    
                                </div>
                            </div>
                            
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">已选学号</label>
                                <div id="selected-numbers" class="flex flex-wrap gap-2 p-4 glass-effect border border-white/30 rounded-xl min-h-[80px] transition-all duration-300"></div>
                            </div>
                            
                            
                            <button id="add-homework-record" class="w-full gradient-border bg-secondary hover:bg-secondary/90 text-white py-3 rounded-xl transition-all duration-300 hover:shadow-lg mb-6">
                                添加未交作业记录
                            </button>
                            
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">已记录列表</label>
                                <div id="homework-records" class="space-y-3 max-h-64 overflow-y-auto scrollbar-hide p-3 glass-effect border border-white/30 rounded-xl"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div class="lg:col-span-2">
                    <div class="glass-effect rounded-xl p-6 h-full hover-lift">
                        <h3 class="text-xl font-semibold mb-5 text-dark flex items-center gap-2">
                            <i class="fa fa-book text-primary animate-pulse-slow"></i>
                            课程表现评分
                        </h3>
                        
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">选择星期</label>
                            <div class="flex flex-wrap gap-2">
                                <button class="day-btn gradient-border bg-primary text-white px-5 py-3 rounded-xl transition-all duration-300 hover:shadow-lg" data-day="周一">周一</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周二">周二</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周三">周三</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周四">周四</button>
                                <button class="day-btn glass-effect border border-white/30 hover:bg-primary/10 px-5 py-3 rounded-xl transition-all duration-300" data-day="周五">周五</button>
                            </div>
                        </div>
                        
                        
                        <div class="mb-4">
                            <button id="add-new-course" class="gradient-border bg-secondary hover:bg-secondary/90 text-white px-5 py-3 rounded-xl transition-all duration-300 hover:shadow-lg flex items-center gap-2">
                                <i class="fa fa-plus"></i>
                                <span>添加新课</span>
                            </button>
                        </div>
                        
                        
                        <div id="schedule-container" class="space-y-3 max-h-[calc(100vh-280px)] overflow-y-auto scrollbar-hide pb-2">
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- 你知道吗栏目 -->
        <div class="glass-effect rounded-2xl shadow-xl overflow-hidden mb-8 hover-lift">
            <div class="p-5 border-b border-white/20 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-dark flex items-center gap-2">
                    <i class="fa fa-lightbulb-o text-warning animate-pulse-slow"></i>
                    你知道吗？ (我不知道)
                </h3>
                <button id="fun-fact-refresh" class="gradient-border bg-accent hover:bg-accent/90 text-white px-4 py-2 rounded-lg transition-all duration-300 flex items-center gap-2 hover:shadow-lg">
                    <i class="fa fa-refresh"></i>
                    <span>查看新知识</span>
                </button>
            </div>
            <div class="p-6">
                <div class="glass-effect-dark text-white p-6 rounded-xl mb-4 transition-all duration-300 hover:shadow-lg">
                    <p id="fun-fact-content" class="text-lg leading-relaxed"></p>
                </div>
                <div class="mt-4 text-right flex justify-between items-center">
                    <span class="text-sm text-gray-600 italic">点击上方按钮获取新知识，或等待自动刷新</span>
                    <span id="fact-refresh-timer" class="text-sm text-gray-500 flex items-center gap-1">
                        <i class="fa fa-clock-o"></i>
                        <span>下次刷新: <span id="countdown">60</span>秒</span>
                    </span>
                </div>
            </div>
        </div>
        
        <footer class="text-center text-gray-500 text-sm mt-12">
            <p>GlidePlum &copy; 2025 All_lan</p>
        </footer>
    </div>

    <script>
        // 初始化变量
        let currentDay = "周一";
        let selectedStudentNumbers = [];
        let scheduleData = {
            "周一": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周二": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周三": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周四": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周五": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周六": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
            "周日": Array(8).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] }))
        };
        let homeworkRecords = [];
        
        // 班级配置 - 可自定义
        let classConfig = {
            minStudentId: 1,
            maxStudentId: 50,
            excludedIds: [21, 22, 23, 24, 25, 26, 27, 28, 29,30], // 排除的学号
            subjects: ["语文", "数学", "英语", "物理", "化学", "生物", "历史", "地理", "政治", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
            gradeSubjects: {
                "初一": ["语文", "数学", "英语", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"]
            },
            classInfo: {
                name: "初一二班",
                grade: "初一",
                motto: "「怀少年意气而不躁，守初心本真而不迂；于求知中砺本领，于共情中暖彼此」"
            }
        };
        
        // IndexedDB 数据库
        const DB_NAME = 'slss-database';
        const DB_VERSION = 5; // 数据库版本号
        let db = null;
        
        // 初始化 IndexedDB
        function initDatabase() {
            return new Promise((resolve, reject) => {
                if (db) {
                    resolve(db);
                    return;
                }
                
                try {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    
                    request.onerror = () => {
                        console.error('数据库打开失败:', request.error);
                        // 即使数据库失败，也返回resolve以便应用继续运行
                        resolve(null);
                    };
                    
                    request.onsuccess = () => {
                        db = request.result;
                        console.log('数据库打开成功');
                        resolve(db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        
                        // 创建或更新课程表数据存储
                        if (!db.objectStoreNames.contains('schedule')) {
                            db.createObjectStore('schedule', { keyPath: 'day' });
                        }
                        
                        // 创建或更新作业记录数据存储
                        if (!db.objectStoreNames.contains('homework')) {
                            const homeworkStore = db.createObjectStore('homework', { keyPath: 'id' });
                            if (!homeworkStore.indexNames.contains('by-date')) {
                                homeworkStore.createIndex('by-date', 'date', { unique: false });
                            }
                            if (!homeworkStore.indexNames.contains('by-subject')) {
                                homeworkStore.createIndex('by-subject', 'subject', { unique: false });
                            }
                        }
                        
                        // 创建或更新配置存储
                        if (!db.objectStoreNames.contains('config')) {
                            const configStore = db.createObjectStore('config', { keyPath: 'id' });
                            // 存储默认配置
                            configStore.put({ 
                                id: 'class-config', 
                                data: {
                                    minStudentId: 1,
                                    maxStudentId: 50,
                                    excludedIds: [21, 22, 23, 24, 25, 26, 27, 28, 29],
                                    subjects: ["语文", "数学", "英语", "物理", "化学", "生物", "历史", "地理", "政治", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                                    gradeSubjects: {
                                        "初一": ["语文", "数学", "英语", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                                        "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                                        "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"]
                                    },
                                    classInfo: {
                                    name: "初一二班",
                                    grade: "初一",
                                    motto: "「怀少年意气而不躁，守初心本真而不迂；于求知中砺本领，于共情中暖彼此」"
                                }
                                }
                            });
                        }
                    };
                } catch (error) {
                    console.error('数据库初始化异常:', error);
                    resolve(null);
                }
            });
        }
        
        // 保存班级配置
        function saveClassConfig() {
            if (!db) return;
            
            const transaction = db.transaction(['config'], 'readwrite');
            const store = transaction.objectStore('config');
            store.put({ id: 'class-config', data: classConfig });
            
            transaction.oncomplete = () => {
                console.log('班级配置保存成功');
            };
        }
        
        // 加载班级配置
        function loadClassConfig() {
            return new Promise((resolve) => {
                // 确保gradeSubjects配置始终存在
                if (!classConfig.gradeSubjects) {
                    classConfig.gradeSubjects = {
                        "初一": ["语文", "数学", "英语", "历史", "地理", "政治", "生物", "体育", "心理", "信息"],
                        "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治", "生物", "体育", "心理", "信息"],
                        "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治", "生物", "体育", "心理", "信息"]
                    };
                }
                
                try {
                    if (!db) {
                        // 数据库不可用时，确保学科列表正确
                        ensureSubjectsBasedOnGrade();
                        resolve(classConfig);
                        return;
                    }
                    
                    const transaction = db.transaction(['config'], 'readonly');
                    const store = transaction.objectStore('config');
                    const request = store.get('class-config');
                    
                    request.onsuccess = () => {
                        if (request.result && request.result.data) {
                            classConfig = request.result.data;
                            // 确保gradeSubjects配置存在
                            if (!classConfig.gradeSubjects) {
                                classConfig.gradeSubjects = {
                                    "初一": ["语文", "数学", "英语", "历史", "地理", "政治", "生物", "体育", "心理", "信息"],
                                    "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治", "生物", "体育", "心理", "信息"],
                                    "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治", "生物", "体育", "心理", "信息"]
                                };
                            }
                            // 确保学科列表基于年级正确设置
                            ensureSubjectsBasedOnGrade();
                        } else {
                            // 没有配置数据时，确保学科列表正确
                            ensureSubjectsBasedOnGrade();
                        }
                        // 更新页面标题和班训
                document.querySelector('h1').textContent = `${classConfig.classInfo.name}学情统计`;
                updateClassMotto();
                resolve(classConfig);
                    };
                    
                    request.onerror = () => {
                        console.error('加载班级配置失败');
                        // 出错时确保学科列表正确
                        ensureSubjectsBasedOnGrade();
                        resolve(classConfig);
                    };
                } catch (error) {
                    console.error('加载班级配置异常:', error);
                    // 异常时确保学科列表正确
                    ensureSubjectsBasedOnGrade();
                    resolve(classConfig);
                }
            });
        }
        
        // 确保学科列表基于年级正确设置
        function ensureSubjectsBasedOnGrade() {
            const grade = classConfig.classInfo.grade;
            if (!grade) {
                // 如果没有年级设置，默认使用初一
                classConfig.classInfo.grade = "初一";
                classConfig.subjects = [...classConfig.gradeSubjects["初一"]];
            } else if (classConfig.gradeSubjects[grade]) {
                // 如果是预设年级，关联对应学科
                classConfig.subjects = [...classConfig.gradeSubjects[grade]];
            } else {
                // 自定义年级使用默认基础学科
                classConfig.subjects = ['语文', '数学', '英语'];
            }
        }
        
        // 创建科目选择模态框
        function createSubjectSelectionModal() {
            const modal = document.createElement('div');
            modal.id = 'subject-selection-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-md p-6">
                    <div class="p-4 border-b border-white/20 mb-4">
                        <h2 class="text-xl font-bold text-dark">选择科目</h2>
                    </div>
                    <div class="max-h-80 overflow-y-auto p-2">
                        <div id="subject-options" class="grid grid-cols-2 gap-3">
                            <!-- 科目选项将通过JavaScript动态生成 -->
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="close-subject-modal" class="w-full px-4 py-3 gradient-border bg-primary hover:bg-primary/90 text-white rounded-xl transition-all duration-300 hover:shadow-lg">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 添加关闭事件
            document.getElementById('close-subject-modal').addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }
        
        // 生成科目选择器
        function generateSubjectSelect() {
            // 过滤掉不需要的科目：自习、美术、音乐、班会、心理、信息、体育
            const excludedSubjects = ['自习', '美术', '音乐', '班会', '心理', '信息', '体育'];
            const filteredSubjects = classConfig.subjects.filter(subject => 
                !excludedSubjects.includes(subject)
            );
            
            // 创建并绑定科目选择模态框
            if (!document.getElementById('subject-selection-modal')) {
                createSubjectSelectionModal();
            }
            
            // 清空现有选项
            const optionsContainer = document.getElementById('subject-options');
            optionsContainer.innerHTML = '';
            
            // 添加自定义选项
            const customOption = document.createElement('button');
            customOption.className = 'subject-option-btn py-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 hover-lift';
            customOption.dataset.subject = '自定义';
            customOption.textContent = '自定义';
            customOption.addEventListener('click', function() {
                document.getElementById('selected-subject-text').textContent = '自定义';
                document.getElementById('subject-selection-modal').classList.add('hidden');
            });
            optionsContainer.appendChild(customOption);
            
            // 添加科目选项
            filteredSubjects.forEach(subject => {
                const option = document.createElement('button');
                option.className = 'subject-option-btn py-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 hover-lift';
                option.dataset.subject = subject;
                option.textContent = subject;
                option.addEventListener('click', function() {
                    document.getElementById('selected-subject-text').textContent = subject;
                    document.getElementById('subject-selection-modal').classList.add('hidden');
                });
                optionsContainer.appendChild(option);
            });
            
            // 绑定选择按钮事件
            document.getElementById('subject-select-btn').addEventListener('click', function() {
                document.getElementById('subject-selection-modal').classList.remove('hidden');
            });
        }
        
        // 添加配置和导入功能
        function addConfigAndImportFeatures() {
            // 添加配置按钮到头部
            const header = document.querySelector('header');
            const configBtn = document.createElement('button');
            configBtn.id = 'config-btn';
            configBtn.className = 'gradient-border bg-accent hover:bg-accent/90 text-white px-5 py-2.5 rounded-lg transition-all duration-300 flex items-center gap-2 hover:shadow-lg';
            configBtn.innerHTML = '<i class="fa fa-cog"></i><span>配置</span>';
            header.appendChild(configBtn);
            
            // 添加导入按钮
            const exportBtn = document.getElementById('export-excel');
            const importBtn = document.createElement('button');
            importBtn.id = 'import-data';
            importBtn.className = 'gradient-border bg-secondary hover:bg-secondary/90 text-white px-5 py-2.5 rounded-lg transition-all duration-300 flex items-center gap-2 hover:shadow-lg ml-3';
            importBtn.innerHTML = '<i class="fa fa-upload"></i><span>导入数据</span>';
            exportBtn.parentNode.appendChild(importBtn);
            
            // 创建隐藏的文件输入
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            fileInput.id = 'file-import';
            document.body.appendChild(fileInput);
            
            // 绑定导入按钮事件
            importBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            // 处理文件导入
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        // 验证导入的数据结构
                        if (importedData.homeworkRecords) {
                            homeworkRecords = importedData.homeworkRecords;
                            displayHomeworkRecords();
                            saveHomeworkRecords();
                        }
                        
                        if (importedData.scheduleData) {
                            scheduleData = importedData.scheduleData;
                            generateSchedule();
                            saveScheduleData();
                        }
                        
                        if (importedData.classConfig) {
                            classConfig = importedData.classConfig;
                            generateSubjectSelect();
                            generateStudentNumberButtons();
                            saveClassConfig();
                            // 更新页面标题
                            document.querySelector('h1').textContent = `${classConfig.classInfo.name}学情统计`;
                        }
                        
                        showToast('数据导入成功！', 'success');
                    } catch (error) {
                        showToast('数据导入失败：文件格式错误或内容无效', 'error');
                    }
                    
                    // 重置文件输入
                    this.value = '';
                };
                reader.readAsText(file);
            });
            
            // 绑定配置按钮事件
            configBtn.addEventListener('click', openConfigModal);
            
            // 创建配置模态框
            createConfigModal();
        }
        
        // 创建配置模态框
        function createConfigModal() {
            const modal = document.createElement('div');
            modal.id = 'config-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-white/20">
                        <h2 class="text-2xl font-bold text-dark flex items-center gap-2">
                            <i class="fa fa-cog text-accent"></i>
                            班级配置
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <h3 class="font-medium text-dark mb-3">班级信息</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">班级名称</label>
                                    <div class="relative">
                                        <input type="text" id="config-class-name-display" value="${classConfig.classInfo.name}" readonly 
                                            class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300 cursor-pointer bg-white/10">
                                        <button id="open-class-selector" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-primary transition-colors duration-300">
                                            <i class="fa fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <input type="hidden" id="config-class-name" value="${classConfig.classInfo.name}">
                                    <input type="hidden" id="config-class-grade" value="${classConfig.classInfo.grade || '初一'}">
                                    
                                    <!-- 班级选择模态框 -->
                                    <div id="class-selection-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
                                        <div class="glass-effect rounded-2xl w-full max-w-2xl p-6 transform transition-all duration-300 hover:shadow-xl">
                                            <div class="p-4 border-b border-white/20 mb-4">
                                                <h2 class="text-xl font-bold text-dark">选择班级</h2>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                                <div>
                                                    <h3 class="text-dark font-medium mb-3">选择年级</h3>
                                                    <div class="space-y-2 grade-selection">
                                                        <button class="grade-btn w-full p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.grade === '初一' ? 'selected border-primary' : ''}" data-grade="初一">初一</button>
                                                        <button class="grade-btn w-full p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.grade === '初二' ? 'selected border-primary' : ''}" data-grade="初二">初二</button>
                                                        <button class="grade-btn w-full p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.grade === '初三' ? 'selected border-primary' : ''}" data-grade="初三">初三</button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h3 class="text-dark font-medium mb-3">选择班级</h3>
                                                    <div class="grid grid-cols-2 gap-2 class-selection">
                                                        <button class="class-btn p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.name.includes('一班') ? 'selected border-primary' : ''}" data-class="一班">一班</button>
                                                        <button class="class-btn p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.name.includes('二班') ? 'selected border-primary' : ''}" data-class="二班">二班</button>
                                                        <button class="class-btn p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.name.includes('三班') ? 'selected border-primary' : ''}" data-class="三班">三班</button>
                                                        <button class="class-btn p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.name.includes('四班') ? 'selected border-primary' : ''}" data-class="四班">四班</button>
                                                        <button class="class-btn p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.name.includes('五班') ? 'selected border-primary' : ''}" data-class="五班">五班</button>
                                                        <button class="class-btn p-3 glass-effect border border-white/30 rounded-xl hover:bg-primary/10 transition-all duration-300 ${classConfig.classInfo.name.includes('六班') ? 'selected border-primary' : ''}" data-class="六班">六班</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex gap-3">
                                                <button id="class-selection-cancel" class="flex-1 px-4 py-3 glass-effect border border-white/30 rounded-xl hover:bg-gray-200/20 transition-all duration-300">
                                                    取消
                                                </button>
                                                <button id="class-selection-confirm" class="flex-1 px-4 py-3 gradient-border bg-primary hover:bg-primary/90 text-white rounded-xl transition-all duration-300 hover:shadow-lg">
                                                    确认
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">年级（将自动关联对应学科）</label>
                                    <select id="config-grade" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                        <option value="初一" ${classConfig.classInfo.grade === "初一" ? 'selected' : ''}>初一</option>
                                        <option value="初二" ${classConfig.classInfo.grade === "初二" ? 'selected' : ''}>初二</option>
                                        <option value="初三" ${classConfig.classInfo.grade === "初三" ? 'selected' : ''}>初三</option>
                                        <option value="自定义" ${!['初一', '初二', '初三'].includes(classConfig.classInfo.grade) ? 'selected' : ''}>自定义</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">班训</label>
                                <input id="config-class-motto" type="text" value="${classConfig.classInfo.motto || ''}" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" placeholder="输入班级班训">
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">学号范围</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">最小学号</label>
                                    <input id="config-min-id" type="number" value="${classConfig.minStudentId}" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">最大学号</label>
                                    <input id="config-max-id" type="number" value="${classConfig.maxStudentId}" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">排除的学号</h3>
                            <input id="config-excluded-ids" type="text" value="${classConfig.excludedIds.join(', ')}" placeholder="用逗号分隔，如：21, 22, 23" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                        </div>
                        

                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">课程设置</h3>
                            <label class="block text-sm font-medium text-gray-700 mb-2">每天课程节数</label>
                            <input id="config-max-sections" type="number" min="1" max="20" value="8" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                        </div>
                        
                        <div>
                            <h3 class="font-medium text-dark mb-3">数据管理</h3>
                            <div class="space-y-3">
                                <button id="export-all-data" class="w-full gradient-border bg-primary hover:bg-primary/90 text-white py-3 rounded-xl transition-all duration-300 hover:shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa fa-download"></i>
                                    <span>导出所有数据</span>
                                </button>
                                <button id="reset-all-data" class="w-full gradient-border bg-danger hover:bg-danger/90 text-white py-3 rounded-xl transition-all duration-300 hover:shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa fa-refresh"></i>
                                    <span>重置所有数据</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 border-t border-white/20 flex justify-end gap-3">
                        <button id="cancel-config" class="px-5 py-2.5 glass-effect border border-white/30 rounded-lg hover:bg-gray-100/50 transition-all duration-300">取消</button>
                        <button id="save-config" class="px-5 py-2.5 gradient-border bg-accent hover:bg-accent/90 text-white rounded-lg transition-all duration-300 hover:shadow-lg">保存配置</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定模态框事件
            document.getElementById('cancel-config').addEventListener('click', closeConfigModal);
            document.getElementById('save-config').addEventListener('click', saveConfigChanges);
            document.getElementById('export-all-data').addEventListener('click', exportAllData);
            document.getElementById('reset-all-data').addEventListener('click', resetAllData);
            
            // 绑定班级选择事件
            const classNameDisplay = document.getElementById('config-class-name-display');
            const openClassSelectorBtn = document.getElementById('open-class-selector');
            
            if (classNameDisplay) {
                classNameDisplay.addEventListener('click', openClassSelectionModal);
            }
            
            if (openClassSelectorBtn) {
                openClassSelectorBtn.addEventListener('click', openClassSelectionModal);
            }
        }
        
        // 打开班级选择模态框
        function openClassSelectionModal() {
            const modal = document.getElementById('class-selection-modal');
            if (modal) {
                modal.classList.remove('hidden');
                // 防止背景滚动
                document.body.style.overflow = 'hidden';
                
                // 初始化选中状态
                const gradeBtns = modal.querySelectorAll('.grade-btn');
                const classBtns = modal.querySelectorAll('.class-btn');
                
                // 清除所有选中状态
                gradeBtns.forEach(btn => btn.classList.remove('selected', 'border-primary'));
                classBtns.forEach(btn => btn.classList.remove('selected', 'border-primary'));
                
                // 设置当前选中状态
                const currentGrade = document.getElementById('config-class-grade').value || '初一';
                const currentClassName = document.getElementById('config-class-name').value || '初一二班';
                
                const selectedGradeBtn = modal.querySelector(`.grade-btn[data-grade="${currentGrade}"]`);
                const selectedClassBtn = modal.querySelector(`.class-btn[data-class="${currentClassName.substring(2)}"]`);
                
                if (selectedGradeBtn) selectedGradeBtn.classList.add('selected', 'border-primary');
                if (selectedClassBtn) selectedClassBtn.classList.add('selected', 'border-primary');
                
                // 添加年级按钮点击事件
                gradeBtns.forEach(btn => {
                    btn.onclick = function() {
                        gradeBtns.forEach(b => b.classList.remove('selected', 'border-primary'));
                        this.classList.add('selected', 'border-primary');
                    };
                });
                
                // 添加班级按钮点击事件
                classBtns.forEach(btn => {
                    btn.onclick = function() {
                        classBtns.forEach(b => b.classList.remove('selected', 'border-primary'));
                        this.classList.add('selected', 'border-primary');
                    };
                });
                
                // 确认按钮事件
                const confirmBtn = modal.querySelector('#class-selection-confirm');
                confirmBtn.onclick = function() {
                    const selectedGrade = modal.querySelector('.grade-btn.selected')?.dataset.grade || currentGrade;
                    const selectedClass = modal.querySelector('.class-btn.selected')?.dataset.class || currentClassName.substring(2);
                    
                    // 更新隐藏输入
                    document.getElementById('config-class-grade').value = selectedGrade;
                    document.getElementById('config-class-name').value = `${selectedGrade}${selectedClass}`;
                    
                    // 更新显示输入
                    document.getElementById('config-class-name-display').value = `${selectedGrade}${selectedClass}`;
                    
                    // 关闭模态框
                    closeClassSelectionModal();
                    
                    // 显示成功提示
                    showToast(`已选择 ${selectedGrade}${selectedClass}`, 'success');
                };
                
                // 取消按钮事件
                const cancelBtn = modal.querySelector('#class-selection-cancel');
                cancelBtn.onclick = closeClassSelectionModal;
                
                // 点击背景关闭
                modal.onclick = function(e) {
                    if (e.target === modal) closeClassSelectionModal();
                };
                
                // ESC键关闭
                function handleEsc(e) {
                    if (e.key === 'Escape') {
                        closeClassSelectionModal();
                        document.removeEventListener('keydown', handleEsc);
                    }
                }
                document.addEventListener('keydown', handleEsc);
            }
        }
        
        // 关闭班级选择模态框
        function closeClassSelectionModal() {
            const modal = document.getElementById('class-selection-modal');
            if (modal) {
                modal.classList.add('hidden');
                // 恢复背景滚动
                document.body.style.overflow = '';
            }
        }
        
        // 打开配置模态框
        function openConfigModal() {
            document.getElementById('config-modal').classList.remove('hidden');
            // 防止背景滚动
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭配置模态框
        function closeConfigModal() {
            document.getElementById('config-modal').classList.add('hidden');
            // 恢复背景滚动
            document.body.style.overflow = '';
        }
        
        // 保存配置更改
        function saveConfigChanges() {
            try {
                classConfig.classInfo.name = document.getElementById('config-class-name').value || '班级';
                classConfig.classInfo.motto = document.getElementById('config-class-motto').value || '';
                const selectedGrade = document.getElementById('config-grade').value;
                
                // 如果选择了预设年级，自动关联对应学科
                if (selectedGrade !== '自定义' && classConfig.gradeSubjects[selectedGrade]) {
                    classConfig.classInfo.grade = selectedGrade;
                    classConfig.subjects = [...classConfig.gradeSubjects[selectedGrade]]; // 复制预设学科列表
                } else {
                    classConfig.classInfo.grade = '自定义';
                    // 对于自定义年级，使用默认的基础学科
                    classConfig.subjects = ['语文', '数学', '英语'];
                }
                
                classConfig.minStudentId = parseInt(document.getElementById('config-min-id').value) || 1;
                classConfig.maxStudentId = parseInt(document.getElementById('config-max-id').value) || 50;
                classConfig.maxClassSections = parseInt(document.getElementById('config-max-sections').value) || 8;
                
                // 解析排除的学号
                const excludedIdsStr = document.getElementById('config-excluded-ids').value;
                classConfig.excludedIds = excludedIdsStr ? excludedIdsStr.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id)) : [];
                
                // 验证课程节数
                if (classConfig.maxClassSections < 1 || classConfig.maxClassSections > 20) {
                    showToast('课程节数必须在1-20之间！', 'warning');
                    return;
                }
                
                // 验证配置
                if (classConfig.minStudentId > classConfig.maxStudentId) {
                    showToast('最小学号不能大于最大学号！', 'warning');
                    return;
                }
                
                // 保存配置
                saveClassConfig();
                
                // 关闭模态框
                closeConfigModal();
                
                // 提示用户并准备刷新页面
                showToast('配置保存成功！页面将自动刷新以应用更改。', 'success');
                
                // 延迟一小段时间后刷新页面，确保用户能看到提示信息
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } catch (error) {
                showToast('配置保存失败：' + error.message, 'error');
            }
        }
        
        // 导出所有数据
        function exportAllData() {
            const allData = {
                classConfig: classConfig,
                scheduleData: scheduleData,
                homeworkRecords: homeworkRecords,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `SLSS_数据导出_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // 创建毛玻璃风格确认对话框
        function createGlassConfirmDialog(title, message, onConfirm, onCancel) {
            // 检查是否已存在对话框
            const existingDialog = document.querySelector('#glass-confirm-dialog');
            if (existingDialog) existingDialog.remove();
            
            // 创建对话框容器
            const dialogContainer = document.createElement('div');
            dialogContainer.id = 'glass-confirm-dialog';
            dialogContainer.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
            
            // 设置对话框HTML内容
            dialogContainer.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-md overflow-hidden transform transition-all duration-300 hover:shadow-xl">
                    <div class="p-6 border-b border-white/20">
                        <h3 class="text-xl font-bold text-dark">${title}</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-dark/90 mb-6">${message}</p>
                        <div class="flex gap-3">
                            <button id="confirm-cancel" class="flex-1 py-3 rounded-lg border border-gray-300 hover:bg-gray-100 text-dark transition-all duration-300">
                                取消
                            </button>
                            <button id="confirm-accept" class="flex-1 py-3 rounded-lg bg-danger hover:bg-danger/90 text-white transition-all duration-300">
                                确认
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到文档
            document.body.appendChild(dialogContainer);
            
            // 添加事件监听器
            const cancelBtn = dialogContainer.querySelector('#confirm-cancel');
            const acceptBtn = dialogContainer.querySelector('#confirm-accept');
            
            const handleCancel = () => {
                dialogContainer.remove();
                if (onCancel) onCancel();
            };
            
            const handleAccept = () => {
                dialogContainer.remove();
                if (onConfirm) onConfirm();
            };
            
            cancelBtn.addEventListener('click', handleCancel);
            acceptBtn.addEventListener('click', handleAccept);
            
            // 点击背景关闭
            dialogContainer.addEventListener('click', (e) => {
                if (e.target === dialogContainer) handleCancel();
            });
            
            // ESC键关闭
            document.addEventListener('keydown', function handleEsc(e) {
                if (e.key === 'Escape') {
                    handleCancel();
                    document.removeEventListener('keydown', handleEsc);
                }
            });
        }
        
        // 重置所有数据
        function resetAllData() {
            createGlassConfirmDialog(
                '确认重置数据',
                '确定要重置所有数据吗？此操作不可撤销！',
                () => {
                    // 用户确认后的操作
                    // 重置内存中的数据
                    const maxSections = classConfig.maxClassSections || 8;
                    scheduleData = {
                        "周一": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                        "周二": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                        "周三": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                        "周四": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                        "周五": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                        "周六": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] })),
                        "周日": Array(maxSections).fill(null).map((_, i) => ({ id: i + 1, subject: '', rating: 0, notes: '', poorStudents: [] }))
                    };
                    homeworkRecords = [];
                    selectedStudentNumbers = [];
                    
                    // 使用单一事务清除所有数据库数据
                    if (db) {
                        try {
                            // 使用一个事务处理所有存储对象的清除
                            const transaction = db.transaction(['schedule', 'homework', 'config'], 'readwrite');
                            
                            // 清除所有存储对象
                            transaction.objectStore('schedule').clear();
                            transaction.objectStore('homework').clear();
                            transaction.objectStore('config').clear(); // 清除配置数据
                            
                            // 事务完成后更新UI和保存默认配置
                            transaction.oncomplete = () => {
                                console.log('所有数据库数据已清除');
                                
                                // 重置为默认班级配置
                                classConfig = {
                                    minStudentId: 1,
                                    maxStudentId: 50,
                                    excludedIds: [21, 22, 23, 24, 25, 26, 27, 28, 29, 30],
                                    subjects: ["语文", "数学", "英语", "物理", "化学", "生物", "历史", "地理", "政治", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                                    gradeSubjects: {
                                        "初一": ["语文", "数学", "英语", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                                        "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"],
                                        "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治", "生物", "体育", "心理", "信息", "音乐", "美术", "自习", "班会"]
                                    },
                                    classInfo: {
                                        name: "初一二班",
                                        grade: "初一",
                                        motto: "「怀少年意气而不躁，守初心本真而不迂；于求知中砺本领，于共情中暖彼此」"
                                    }
                                };
                                
                                // 保存默认配置
                                saveClassConfig();
                                
                                // 更新UI
                                updateUIAfterReset();
                            };
                            
                            transaction.onerror = (event) => {
                                console.error('清除数据库数据失败:', event.target.error);
                                // 即使出错也更新UI
                                updateUIAfterReset();
                            };
                        } catch (error) {
                            console.error('重置数据库时发生异常:', error);
                            // 异常情况下也更新UI
                            updateUIAfterReset();
                        }
                    } else {
                        // 数据库不可用时，直接更新UI
                        updateUIAfterReset();
                    }
                },
                () => {
                    // 用户取消后的操作（可选）
                    console.log('用户取消了数据重置');
                }
            );
        }
        
        // 重置后更新UI的辅助函数
        function updateUIAfterReset() {
            // 更新UI
            generateSubjectSelect();
            generateStudentNumberButtons();
            generateSchedule();
            displayHomeworkRecords();
            updateSelectedNumbersDisplay();
            
            // 更新页面标题和班训
            document.querySelector('h1').textContent = `${classConfig.classInfo.name}学情统计`;
            updateClassMotto();
            
            // 使用Toast提示替代alert
            showToast('所有数据已重置！', 'success');
        }
        
        // 保存课程表数据到 IndexedDB
        function saveScheduleData() {
            // 数据库未初始化检查
            if (!db) {
                console.warn('数据库未初始化，无法保存数据');
                showToast('数据保存失败：数据库未初始化', 'warning');
                return;
            }
            
            try {
                // 验证 scheduleData 是否为有效对象
                if (!scheduleData || typeof scheduleData !== 'object') {
                    console.error('scheduleData 不是有效的数据对象');
                    showToast('数据保存失败：数据格式错误', 'error');
                    return;
                }
                
                console.log('开始保存课程表数据');
                
                // 创建事务
                const transaction = db.transaction(['schedule'], 'readwrite');
                const store = transaction.objectStore('schedule');
                
                // 先清空现有数据
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    console.log('已清空现有数据');
                    
                    // 收集要保存的数据项
                    const daysToSave = Object.keys(scheduleData).filter(dayKey => 
                        dayKey && typeof dayKey === 'string' && dayKey.trim() !== ''
                    );
                    
                    if (daysToSave.length === 0) {
                        console.log('没有有效数据需要保存');
                        return;
                    }
                    
                    // 使用 Promise.all 处理所有保存操作
                    const savePromises = daysToSave.map(dayKey => {
                        return new Promise((resolve, reject) => {
                            // 创建标准化的数据对象
                            const dataObject = {
                                day: String(dayKey).trim(), // 强制转换为字符串并去除空白
                                courses: Array.isArray(scheduleData[dayKey]) ? 
                                    scheduleData[dayKey] : []
                            };
                            
                            console.log('保存对象:', dataObject);
                            
                            // 执行 put 操作
                            const putRequest = store.put(dataObject);
                            putRequest.onsuccess = () => {
                                console.log(`成功保存: ${dayKey}`);
                                resolve();
                            };
                            putRequest.onerror = (event) => {
                                console.error(`保存失败 [${dayKey}]:`, event.target.error);
                                reject(event.target.error);
                            };
                        });
                    });
                    
                    // 等待所有保存完成
                    Promise.allSettled(savePromises).then(results => {
                        const successful = results.filter(r => r.status === 'fulfilled').length;
                        const failed = results.filter(r => r.status === 'rejected').length;
                        
                        console.log(`保存操作完成: 成功 ${successful}, 失败 ${failed}`);
                        
                        if (failed === 0) {
                            showToast('数据保存成功', 'success');
                        } else if (successful > 0) {
                            showToast(`部分数据保存成功 (${successful}/${daysToSave.length})`, 'info');
                        } else {
                            showToast('所有数据保存失败', 'error');
                        }
                    });
                };
                
                clearRequest.onerror = (event) => {
                    console.error('清空数据失败:', event.target.error);
                    showToast('数据保存失败：无法清空旧数据', 'error');
                };
                
                transaction.onerror = (event) => {
                    console.error('事务失败:', event.target.error);
                };
                
            } catch (error) {
                console.error('保存数据异常:', error);
                showToast('数据保存异常，请重试', 'error');
            }
        }
        
        // 从 IndexedDB 加载课程表数据
        function loadScheduleData() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(scheduleData);
                    return;
                }
                
                const transaction = db.transaction(['schedule'], 'readonly');
                const store = transaction.objectStore('schedule');
                const allRequest = store.getAll();
                
                allRequest.onsuccess = () => {
                    const data = allRequest.result;
                    if (data.length > 0) {
                        data.forEach(item => {
                            if (scheduleData.hasOwnProperty(item.day)) {
                                scheduleData[item.day] = item.courses || [];
                            }
                        });
                    }
                    resolve(scheduleData);
                };
                
                allRequest.onerror = () => {
                    console.error('加载课程表数据失败');
                    resolve(scheduleData);
                };
            });
        }
        
        // 保存作业记录到 IndexedDB
        function saveHomeworkRecords() {
            if (!db) return;
            
            const transaction = db.transaction(['homework'], 'readwrite');
            const store = transaction.objectStore('homework');
            
            homeworkRecords.forEach(record => {
                store.put(record);
            });
            
            transaction.oncomplete = () => {
                console.log('作业记录保存成功');
            };
            
            transaction.onerror = () => {
                console.error('作业记录保存失败');
            };
        }
        
        // 从 IndexedDB 加载作业记录
        function loadHomeworkRecords() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve(homeworkRecords);
                    return;
                }
                
                const transaction = db.transaction(['homework'], 'readonly');
                const store = transaction.objectStore('homework');
                const allRequest = store.getAll();
                
                allRequest.onsuccess = () => {
                    homeworkRecords = allRequest.result;
                    resolve(homeworkRecords);
                };
                
                allRequest.onerror = () => {
                    console.error('加载作业记录失败');
                    resolve(homeworkRecords);
                };
            });
        }
        
        // 创建并显示加载动画
        function showLoader() {
            // 检查加载器是否已存在
            let loader = document.getElementById('page-loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'page-loader';
                loader.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center';
                loader.innerHTML = `
                    <div class="glass-effect p-8 rounded-2xl flex flex-col items-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary mb-4"></div>
                        <p id="loader-text" class="text-white text-lg">加载中...</p>
                    </div>
                `;
                document.body.appendChild(loader);
            }
            loader.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        // 隐藏加载动画
        function hideLoader() {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        // 更新加载动画文本
        function updateLoaderText(text) {
            const loaderText = document.getElementById('loader-text');
            if (loaderText) {
                loaderText.textContent = text;
            }
        }
        
        // 创建公告弹窗
        function createAnnouncementModal() {
            const modal = document.createElement('div');
            modal.id = 'announcement-modal';
            modal.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-white/20 flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-dark flex items-center gap-2">
                            <i class="fa fa-bullhorn text-accent"></i>
                            <span>公告</span>
                        </h3>
                        <div id="announcement-timer" class="text-accent font-semibold">5秒后关闭</div>
                    </div>
                    <div class="p-8">
                        <div class="prose max-w-none text-dark">
                            <h4 class="text-xl font-semibold mb-4 text-gradient">点击我已阅读代表您知晓并同意</h4>
                            <p class="mb-4">本项目采用MIT开源许可协议于Github发布:</p>
                            <ul class="list-disc pl-6 mb-4 space-y-2">
                                <li>您可以自由使用、复制、修改、合并、发布本软件</li>
                                <li>您可以将本软件用于商业目的</li>
                                <li>使用本软件时需保留原始许可证声明</li>
                                <li>您可于Github/DL1447/SLSS中获取新版本</li>
                                <li>学号选择系统为了适配作者所在班级 默认排除20-30 请于配置中手动更改</li>
                                <li>二班 On Tooooooooop</li>
                            </ul>
                            <p class="text-sm text-gray-600 italic">© 2025 All_lan | MIT License | SLSS</p>
                        </div>
                    </div>
                    <div class="p-6 border-t border-white/20 flex justify-end">
                        <button id="close-announcement" class="px-6 py-2.5 gradient-border bg-accent hover:bg-accent/90 text-white rounded-lg transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa fa-check"></i>
                            <span>我已阅读</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 倒计时关闭功能
            const closeButton = document.getElementById('close-announcement');
            const timerElement = document.getElementById('announcement-timer');
            let seconds = 5;
            
            closeButton.disabled = true;
            
            const countdownInterval = setInterval(() => {
                seconds--;
                timerElement.textContent = `${seconds}秒后关闭`;
                
                if (seconds <= 0) {
                    clearInterval(countdownInterval);
                    closeButton.disabled = false;
                    timerElement.textContent = '点击"我已阅读"关闭';
                }
            }, 1000);
            
            // 绑定关闭按钮事件
            closeButton.addEventListener('click', () => {
                modal.style.display = 'none';
            });
        }
        
        // 显示公告
        function showAnnouncement() {
            // 获取并更新访问次数
            let visitCount = localStorage.getItem('visitCount');
            visitCount = visitCount ? parseInt(visitCount) + 1 : 1;
            localStorage.setItem('visitCount', visitCount.toString());
            
            // 每5次访问显示一次公告
            if (visitCount % 5 === 0) {
                createAnnouncementModal();
            }
        }
        
        // Toast提示功能 - 支持多通知堆叠显示
        let activeToasts = [];
        
        function showToast(message, type = 'info') {
            // 确保Toast样式已添加
            if (!document.querySelector('#toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    .toast-notification {
                        opacity: 0;
                        transform: translateX(-50%) translateY(20px);
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                        font-weight: 500;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        animation: toastSlideIn 0.3s ease-out forwards;
                        min-width: 200px;
                        text-align: center;
                        transition: all 0.3s ease;
                    }
                    
                    .toast-notification.opacity-100 {
                        opacity: 1;
                        transform: translateX(-50%) translateY(0);
                    }
                    
                    .toast-notification.opacity-0 {
                        opacity: 0;
                        transform: translateX(-50%) translateY(20px);
                    }
                    
                    @keyframes toastSlideIn {
                        from {
                            opacity: 0;
                            transform: translateX(-50%) translateY(20px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(-50%) translateY(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            const toast = document.createElement('div');
            // 移除glass-effect，使用不透明的纯色背景以提高对比度
            toast.className = `toast-notification fixed left-1/2 transform -translate-x-1/2 rounded-xl px-6 py-4 text-white z-50 transition-all duration-300 shadow-lg ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-primary'}`;
            toast.textContent = message;
            
            // 添加到文档和活动通知列表
            document.body.appendChild(toast);
            activeToasts.push(toast);
            
            // 更新所有通知的位置
            updateToastPositions();
            
            // 显示动画已通过CSS实现
            setTimeout(() => {
                toast.classList.add('opacity-100');
            }, 10);
            
            // 3秒后自动关闭
            setTimeout(() => {
                closeToast(toast);
            }, 3000);
        }
        
        // 关闭单个通知并更新其他通知的位置
        function closeToast(toast) {
            toast.classList.add('opacity-0');
            
            setTimeout(() => {
                // 从DOM和活动列表中移除
                toast.remove();
                
                const index = activeToasts.indexOf(toast);
                if (index !== -1) {
                    activeToasts.splice(index, 1);
                }
                
                // 更新剩余通知的位置
                updateToastPositions();
            }, 300);
        }
        
        // 更新所有通知的位置，实现堆叠效果
        function updateToastPositions() {
            activeToasts.forEach((toast, index) => {
                // 从下往上堆叠，第一个通知在最底部
                const bottomPosition = 12 + (index * 70); // 12rem底部边距，每个通知之间70px间隔
                toast.style.bottom = bottomPosition + 'px';
            });
        }
        
        // 有趣的事实数据 - 优化版（移除重复内容并扩充新知识）
        const funFacts = [
            // 学习科学与认知
            "研究表明，老师的反馈对学生的学习成绩有显著影响，及时且具体的反馈可提高学习效率达40%。",
            "在课堂上使用积极的语言可以提高学生参与度，减少课堂行为问题。",
            "记录学生表现是教师专业发展的重要部分，有助于个性化教学调整。",
            "数据显示，及时的课后复习可以将记忆保留率提高30%，而延迟一天复习效果会显著下降。",
            "教学反思有助于提高教师的教学效果，特别是结合学生反馈的反思。",
            "每个学生的学习节奏都是独特的，视觉型学习者约占65%，听觉型约占30%，动觉型约占5%。",
            "鼓励学生提问可以培养批判性思维能力，提问过程本身就是深度思考的体现。",
            "良好的学习环境可以提高注意力集中度，研究发现整洁环境能提高专注力达25%。",
            "定期评估是了解学生学习情况的有效途径，形成性评估比总结性评估更有助于学习。",
            "个性化的学习计划有助于学生发挥潜力，适应不同学习风格的教学可提高学习效果。",
            
            // 记忆与学习技巧
            "互动教学比单向讲授更能提高学习效果，学生参与度与知识保留率正相关。",
            "学生的自信心对学习成绩有重要影响，成长型思维模式的学生更容易面对挑战。",
            "思维导图是组织知识点的有效工具，能将记忆效率提高约25%。",
            "及时纠正错误比反复练习更重要，识别错误模式是深度学习的关键。",
            "鼓励合作学习可以培养团队精神，同伴教学效应可同时提升双方的学习效果。",
            "学习新技能时，短时间、高频率的练习比长时间、低频率的练习更有效，这被称为分散学习效应。",
            "情绪状态会直接影响记忆和学习效果，适度的积极情绪能提高记忆编码效率。",
            "教授他人是巩固知识的最佳方法之一，这种学习方法被称为'费曼学习法'，可将知识保留率提高到90%。",
            "视觉辅助工具可以提高信息记忆效率高达65%，图文结合的学习材料效果最佳。",
            "学习过程中的适当休息有助于知识的巩固和整合，番茄工作法(25分钟学习+5分钟休息)被证明非常有效。",
            
            // 学习策略
            "设置明确的学习目标可以提高学习动力和效率，SMART目标(具体、可衡量、可实现、相关性、时限)特别有效。",
            "将学习内容与个人经验联系起来可以增强记忆，这在认知心理学中称为'编码特异性原则'。",
            "多样化的教学方法可以满足不同学习者的需求，多感官学习能激活大脑多个区域，加深记忆。",
            "正面强化比负面批评更能促进学生的进步，积极反馈能增强学习动机和自信心。",
            "培养成长型思维模式有助于学生应对学习挑战，相信能力可以通过努力提升的学生更容易取得进步。",
            "学习环境中的背景音乐可以提高某些类型任务的效率，巴洛克音乐(60BPM)有助于提高专注力。",
            "手写笔记比打字笔记更有助于信息的理解和记忆，因为手写过程需要更多的认知参与。",
            "实践应用是将理论知识转化为技能的关键步骤，在不同情境中应用知识能增强知识迁移能力。",
            "定期回顾已学知识可以防止遗忘，根据艾宾浩斯遗忘曲线，及时复习能有效减缓遗忘速度。",
            "培养学生的创造力比单纯传授知识更重要，发散思维训练能提高问题解决能力。",
            
            // 学习心理与习惯
            "学生之间的同伴学习可以相互促进成长，同伴反馈提供了不同的视角和思考方式。",
            "合理安排学习时间可以避免认知疲劳，研究表明连续学习超过90分钟效率会显著下降。",
            "给予具体、建设性的反馈比笼统评价更有价值，明确指出优点和改进方向的反馈效果最佳。",
            "建立学习习惯比临时突击学习更有效，习惯形成通常需要21-66天的持续实践。",
            "培养批判性阅读能力是信息时代的重要技能，能帮助辨别信息的真实性和可靠性。",
            "学习中的挫折体验是成长的重要组成部分，克服学习困难的过程能培养韧性和解决问题的能力。",
            "将复杂任务分解为小步骤可以降低学习难度，这种方法被称为'任务分解法'，有助于管理大型学习项目。",
            "学习成果的及时反馈可以调整学习策略，反馈应当包括具体的改进建议。",
            "培养自我管理能力是终身学习的基础，自我调节学习能力与学术成就高度相关。",
            "跨学科学习可以拓宽思维视野，整合不同学科知识能培养综合分析能力。",
            
            // 新增内容：学习科学前沿
            "神经可塑性研究表明，大脑会根据学习活动持续改变，即使在成年后也能形成新的神经连接。",
            "睡眠对学习和记忆至关重要，深度睡眠期间大脑会巩固白天学习的信息，提高睡眠质量可提升学习效率。",
            "冥想和正念练习可以提高专注力和学习效率，每天10分钟的正念练习能显著改善注意力持续时间。",
            "认知负荷理论指出，学习材料的复杂度应当与学习者的认知能力相匹配，避免认知超载。",
            "间隔重复系统(如Anki)利用记忆科学原理，通过优化复习间隔显著提高记忆效率。",
            "元认知策略(了解自己的学习过程)能提高学习效果，培养学生评估自己学习状态的能力至关重要。",
            "环境因素对学习有显著影响，适宜的温度(20-22°C)和充足的自然光能提高学习效率。",
            "数字素养已成为21世纪核心技能，包括信息筛选、批判性评估和负责任使用数字工具的能力。",
            "情感智能在学习中扮演重要角色，自我意识、自我管理、社交意识和关系管理能力影响学习效果。",
            "微学习(Microlearning)将内容分解为短小精悍的模块，适合现代碎片化学习环境，提高知识吸收率。",
            
            // 新增内容：教育与学习趣闻
            "达芬奇在笔记本中使用镜像书写，这种独特的书写方式可能帮助他专注思考并减少干扰。",
            "爱因斯坦每天午休并进行'白日梦'，这种有意识的休息被认为有助于他的创造性思考。",
            "研究表明，教室内植物能提高学生注意力达15%，改善空气质量并减轻压力。",
            "莫扎特效应指的是聆听莫扎特音乐可能短期提升空间推理能力，虽然效果有限但展示了音乐与认知的联系。",
            "美国发明家爱迪生有独特的创意激发方法：在椅子上放松并手持钢球，当入睡时钢球掉落惊醒他，此时捕捉半睡半醒间的创意。",
            "学习第二语言能延缓认知衰退，双语者患阿尔茨海默病的平均年龄比单语者晚4-5年。",
            "古希腊哲学家苏格拉底使用'产婆术'(通过提问引导思考)教学，这种方法至今仍被视为有效的教育技术。",
            "研究显示，站立学习能提高心率和大脑血流，可能增强注意力和信息处理能力。",
            "颜色心理学研究表明，蓝色环境有助于提高创造力，绿色环境有助于减轻眼睛疲劳和提高阅读效率。",
            "孔子在2500多年前就提出'因材施教'的教育理念，这与现代个性化教育思想高度一致。",
            
            // 新增内容：实用学习技巧
            "主动回忆(不看材料尝试回忆内容)比简单重复阅读更有效，这是一种高强度的学习策略。",
            "费曼学习法(以教促学)包含四个步骤：选择概念、用简单语言解释、识别知识缺口、简化和类比。",
            "思维导图应使用关键词而非完整句子，这有助于促进创意联想和记忆。",
            "复习时应采用'交错学习'(混合不同主题)而非'集中学习'(专注单一主题)，能提高长期记忆效果。",
            "创建个人学习空间并保持一致性能增强学习仪式感，条件反射般地进入学习状态。",
            "使用'康奈尔笔记法'(分为笔记区、提示区和总结区)可以提高课堂笔记的组织性和复习效率。",
            "学习前设定具体意图能提高专注度，明确学习目标和预期成果。",
            "教授知识的同时记录学习过程(学习日志)，有助于识别个人学习模式和改进空间。",
            "使用'5秒法则'克服学习拖延：当想学习时，倒数5-4-3-2-1，然后立即开始，避免犹豫和借口。",
            "'番茄工作法'不仅适用于学习，也可用于复习和问题解决，关键是严格执行休息时间。",
            
            // 新增内容：学习与健康
            "身体活动能提高认知功能，研究表明每周至少150分钟中等强度运动能改善记忆力和注意力。",
            "饮食对大脑功能有显著影响，富含Omega-3脂肪酸、抗氧化剂和复合碳水化合物的食物有助于认知健康。",
            "水分摄入不足会影响认知表现，轻度脱水(仅2%)就能显著降低注意力、记忆力和解决问题的能力。",
            "规律作息对学习至关重要，保持一致的睡眠时间能优化记忆巩固和认知功能。",
            "压力管理是有效学习的关键，慢性压力会损害记忆力，但适度压力能提高专注力和表现。",
            "社交联系对学习有积极影响，与同学讨论和合作能深化理解并提供情感支持。",
            "环境噪音对学习的影响因人而异，有些人在安静环境中学习效率更高，而有些人则在适度背景噪音下表现更好。",
            "定期休息和恢复是持续高效学习的基础，过度学习可能导致倦怠和效率下降。",
            "积极的自我对话能提升学习信心和表现，用鼓励性语言替代自我怀疑。",
            "感恩练习有助于改善学习心态，定期反思学习中的进步和收获能增强学习动力。"
        ];
        
        let countdownInterval = null;
        let countdownSeconds = 60;
        
        // 随机显示一个有趣的事实
        function showRandomFunFact() {
            const randomIndex = Math.floor(Math.random() * funFacts.length);
            document.getElementById('fun-fact-content').textContent = funFacts[randomIndex];
            
            // 重置倒计时
            resetCountdown();
        }
        
        // 重置倒计时
        function resetCountdown() {
            clearInterval(countdownInterval);
            countdownSeconds = 60;
            document.getElementById('countdown').textContent = countdownSeconds;
            
            // 开始新的倒计时
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                document.getElementById('countdown').textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    showRandomFunFact();
                }
            }, 1000);
        }
        
        // 初始化"你知道吗"栏目
        function initFunFactSection() {
            // 显示第一个事实
            showRandomFunFact();
            
            // 绑定手动刷新按钮
            document.getElementById('fun-fact-refresh').addEventListener('click', showRandomFunFact);
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', async function() {
            // 显示加载动画
            showLoader();
            
            try {
                // 设置当前日期
                updateCurrentDate();
                
                // 确保classConfig包含gradeSubjects配置
                if (!classConfig.gradeSubjects) {
                    classConfig.gradeSubjects = {
                        "初一": ["语文", "数学", "英语", "历史", "地理", "政治", "生物", "体育", "心理", "信息"],
                        "初二": ["语文", "数学", "英语", "物理", "历史", "地理", "政治", "生物", "体育", "心理", "信息"],
                        "初三": ["语文", "数学", "英语", "物理", "化学", "历史", "地理", "政治", "生物", "体育", "心理", "信息"]
                    };
                }
                
                // 如果没有选择年级，默认使用初一
                if (!classConfig.classInfo.grade) {
                    classConfig.classInfo.grade = "初一";
                    classConfig.subjects = [...classConfig.gradeSubjects["初一"]];
                }
                
                // 更新加载状态
                updateLoaderText('加载数据中...');
                
                // 初始化数据库并加载数据（容错处理）
                try {
                    await initDatabase();
                    // 尝试加载数据，但即使失败也继续
                    try { await loadScheduleData(); } catch (e) { console.error('加载课程表失败:', e); }
                    try { await loadHomeworkRecords(); } catch (e) { console.error('加载作业记录失败:', e); }
                    try { await loadClassConfig(); } catch (e) { console.error('加载班级配置失败:', e); }
                } catch (error) {
                    console.error('数据库初始化失败:', error);
                    // 即使数据库失败，也继续初始化应用
                }
                
                // 更新加载状态
                updateLoaderText('生成界面元素...');
                
                // 生成科目选择器
                generateSubjectSelect();
                
                // 生成学号选择器
                generateStudentNumberButtons();
                
                // 更新班训显示
                updateClassMotto();
                
                // 生成课程表
                generateSchedule();
                
                // 显示作业记录
                displayHomeworkRecords();
                
                // 绑定事件监听器
                bindEventListeners();
                
                // 添加配置按钮和导入功能
                addConfigAndImportFeatures();
                
                // 初始化"你知道吗"栏目
                initFunFactSection();
                
                // 注册Service Worker
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('service-worker.js')
                            .then(registration => {
                                console.log('Service Worker 注册成功:', registration.scope);
                            })
                            .catch(error => {
                                console.log('Service Worker 注册失败:', error);
                            });
                    });
                }
            } catch (error) {
                console.error('初始化失败:', error);
            } finally {
                // 隐藏加载动画
                setTimeout(() => {
                    hideLoader();
                    // 加载完成后显示公告
                    showAnnouncement();
                }, 500); // 短暂延迟，确保用户能看到加载过程
            }
        });
        
        // 更新当前日期
        // 班级选择模态框
        function showClassSelectionModal() {
            // 防止重复创建模态框
            if (document.getElementById('class-selection-modal')) {
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'class-selection-modal';
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="glass-effect rounded-xl p-8 max-w-lg w-full border border-white/30 shadow-xl transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
                    <h3 class="text-xl font-bold text-dark mb-6">选择班级信息</h3>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">年级</label>
                            <select id="grade-selector" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                <option value="初一">初一</option>
                                <option value="初二">初二</option>
                                <option value="初三">初三</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">班级</label>
                            <select id="class-selector" class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300">
                                <option value="一班">一班</option>
                                <option value="二班">二班</option>
                                <option value="三班">三班</option>
                                <option value="四班">四班</option>
                                <option value="五班">五班</option>
                                <option value="六班">六班</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4">
                        <button id="cancel-selection" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100/20 transition-colors duration-300">
                            取消
                        </button>
                        <button id="confirm-selection" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors duration-300">
                            确认
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            
            // 显示动画
            setTimeout(() => {
                document.getElementById('modal-content').classList.remove('scale-95', 'opacity-0');
                document.getElementById('modal-content').classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // 获取当前选择
            const currentGrade = document.getElementById('config-class-grade').value || '初一';
            const currentClass = document.getElementById('config-class-name').value ? 
                document.getElementById('config-class-name').value.replace(/^\S+/, '') : '一班';
            
            // 设置默认选择
            if (document.getElementById('grade-selector')) {
                document.getElementById('grade-selector').value = currentGrade;
            }
            if (document.getElementById('class-selector')) {
                document.getElementById('class-selector').value = currentClass;
            }
            
            // 确认按钮事件
            if (document.getElementById('confirm-selection')) {
                document.getElementById('confirm-selection').addEventListener('click', function() {
                    const selectedGrade = document.getElementById('grade-selector').value;
                    const selectedClass = document.getElementById('class-selector').value;
                    const fullClassName = `${selectedGrade}${selectedClass}`;
                    
                    // 更新显示
                    document.getElementById('config-class-name-display').value = fullClassName;
                    document.getElementById('config-class-name').value = fullClassName;
                    document.getElementById('config-class-grade').value = selectedGrade;
                    
                    // 如果主配置中有grade选择框，也同步更新
                    if (document.getElementById('config-grade')) {
                        document.getElementById('config-grade').value = selectedGrade;
                    }
                    
                    // 更新页面标题
                    document.title = `${fullClassName}学情统计`;
                    const mainTitle = document.querySelector('h1.text-gradient');
                    if (mainTitle) {
                        mainTitle.textContent = `${fullClassName}学情统计`;
                    }
                    
                    // 保存到localStorage
                    classConfig.classInfo.name = fullClassName;
                    classConfig.classInfo.grade = selectedGrade;
                    localStorage.setItem('classConfig', JSON.stringify(classConfig));
                    
                    closeModal();
                    showToast('班级信息更新成功！', 'success');
                });
            }
            
            // 取消按钮事件
            if (document.getElementById('cancel-selection')) {
                document.getElementById('cancel-selection').addEventListener('click', closeModal);
            }
            
            // 点击外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
            
            // 关闭模态框函数
            function closeModal() {
                const modalContent = document.getElementById('modal-content');
                if (modalContent) {
                    modalContent.classList.add('scale-95', 'opacity-0');
                    modalContent.classList.remove('scale-100', 'opacity-100');
                }
                
                setTimeout(() => {
                    if (document.getElementById('class-selection-modal')) {
                        document.body.removeChild(document.getElementById('class-selection-modal'));
                    }
                    document.body.style.overflow = '';
                }, 300);
            }
        }
        
        // 初始化班级选择器点击事件
        document.addEventListener('DOMContentLoaded', function() {
            const openSelector = document.getElementById('open-class-selector');
            const displayInput = document.getElementById('config-class-name-display');
            
            if (openSelector) {
                openSelector.addEventListener('click', showClassSelectionModal);
            }
            if (displayInput) {
                displayInput.addEventListener('click', showClassSelectionModal);
            }
        });
        
        // 更新班训显示
function updateClassMotto() {
    const mottoElement = document.getElementById('class-motto');
    if (mottoElement && classConfig.classInfo.motto) {
        mottoElement.textContent = classConfig.classInfo.motto;
    }
}

function updateCurrentDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('zh-CN', options);
            
            // 自动根据当前日期选择对应的星期（排除周六和周日）
            const dayOfWeek = now.getDay();
            const weekdays = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];
            
            // 如果是周一到周五，自动选择对应的星期
            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                const today = weekdays[dayOfWeek];
                // 只有当页面初次加载时才自动选择日期，避免干扰用户的手动选择
                if (!window.currentDayAutoSelected) {
                    currentDay = today;
                    window.currentDayAutoSelected = true;
                    console.log(`自动选择日期: ${today}`);
                }
            } else {
                console.log('当前是周末，使用默认日期');
            }
        }
        
        // 生成学号选择器
        function generateStudentNumberButtons() {
            // 查找或创建批量操作按钮容器
            let batchContainer = document.getElementById('batch-controls-container');
            if (!batchContainer) {
                batchContainer = document.createElement('div');
                batchContainer.id = 'batch-controls-container';
                batchContainer.className = 'mb-6';
                
                // 将批量操作容器插入到学号选择器之前
                const container = document.getElementById('student-numbers');
                container.parentNode.insertBefore(batchContainer, container);
            }
            
            // 设置批量操作按钮
            batchContainer.innerHTML = `
                <div class="flex gap-3 p-4 glass-effect border border-white/20 rounded-xl">
                    <button id="select-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                        全选
                    </button>
                    <button id="select-range-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                        选择范围
                    </button>
                    <button id="clear-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                        清空选择
                    </button>
                </div>
            `;
            
            // 绑定批量操作事件
            document.getElementById('select-all-btn').addEventListener('click', selectAllStudents);
            document.getElementById('select-range-btn').addEventListener('click', selectStudentRange);
            document.getElementById('clear-all-btn').addEventListener('click', clearAllStudentSelections);
            
            // 清空并生成学号按钮
            const container = document.getElementById('student-numbers');
            container.innerHTML = '';
            
            // 根据配置生成学号按钮
            for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                // 跳过排除的学号
                if (classConfig.excludedIds.includes(i)) continue;
                
                const button = document.createElement('button');
                button.className = 'student-number-btn w-12 h-12 flex items-center justify-center rounded-full glass-effect border border-white/30 hover:bg-primary/10 transition-all duration-300 hover-lift';
                button.textContent = i;
                button.dataset.number = i;
                
                button.addEventListener('click', function() {
                    toggleStudentNumber(i);
                });
                
                container.appendChild(button);
            }
        }
        
        // 批量操作函数
        function selectAllStudents() {
            selectedStudentNumbers = [];
            
            for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                if (!classConfig.excludedIds.includes(i)) {
                    selectedStudentNumbers.push(i);
                }
            }
            
            updateStudentNumberButtons();
            updateSelectedNumbersDisplay();
        }
        
        // 创建自定义输入模态框
        function createInputModal(title, placeholder, defaultValue = '', onConfirm) {
            // 创建模态框容器
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-md">
                    <div class="p-6 border-b border-white/20">
                        <h3 class="text-xl font-bold text-dark">${title}</h3>
                    </div>
                    <div class="p-6">
                        <input 
                            type="text" 
                            id="modal-input" 
                            class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300"
                            placeholder="${placeholder}"
                            value="${defaultValue}"
                        >
                    </div>
                    <div class="p-6 border-t border-white/20 flex gap-3">
                        <button id="modal-cancel" class="flex-1 px-4 py-3 glass-effect border border-white/30 rounded-xl hover:bg-gray-200/20 transition-all duration-300">
                            取消
                        </button>
                        <button id="modal-confirm" class="flex-1 px-4 py-3 gradient-border bg-primary hover:bg-primary/90 text-white rounded-xl transition-all duration-300 hover:shadow-lg">
                            确认
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const input = document.getElementById('modal-input');
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            
            // 自动聚焦输入框
            input.focus();
            input.select();
            
            // 取消按钮事件
            cancelBtn.addEventListener('click', () => {
                modal.remove();
            });
            
            // 确认按钮事件
            confirmBtn.addEventListener('click', () => {
                const value = input.value;
                modal.remove();
                onConfirm(value);
            });
            
            // 回车键确认
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const value = input.value;
                    modal.remove();
                    onConfirm(value);
                }
            });
            
            // ESC键取消
            document.addEventListener('keydown', function handleEsc(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            });
        }
        
        function selectStudentRange() {
            createInputModal(
                '选择学号范围', 
                '请输入学号范围（格式：开始-结束，如 1-10）', 
                '',
                (rangeInput) => {
                    if (!rangeInput) return;
                    
                    const [start, end] = rangeInput.split('-').map(Number);
                    if (isNaN(start) || isNaN(end) || start > end) {
                        showToast('请输入有效的范围格式！', 'error');
                        return;
                    }
                    
                    // 验证范围在有效范围内
                    if (start < classConfig.minStudentId || end > classConfig.maxStudentId) {
                        showToast(`范围必须在 ${classConfig.minStudentId}-${classConfig.maxStudentId} 之间！`, 'error');
                        return;
                    }
                    
                    // 添加范围内的学号
                    for (let i = start; i <= end; i++) {
                        if (!classConfig.excludedIds.includes(i) && !selectedStudentNumbers.includes(i)) {
                            selectedStudentNumbers.push(i);
                        }
                    }
                    
                    updateStudentNumberButtons();
                    updateSelectedNumbersDisplay();
                }
            );
        }
        
        function clearAllStudentSelections() {
            selectedStudentNumbers = [];
            updateStudentNumberButtons();
            updateSelectedNumbersDisplay();
        }
        
        function updateStudentNumberButtons() {
            document.querySelectorAll('.student-number-btn').forEach(button => {
                const number = parseInt(button.dataset.number);
                if (selectedStudentNumbers.includes(number)) {
                    button.classList.add('bg-primary/20', 'border-primary');
                } else {
                    button.classList.remove('bg-primary/20', 'border-primary');
                }
            });
        }
        
        // 切换学号选择状态
        function toggleStudentNumber(number) {
            const index = selectedStudentNumbers.indexOf(number);
            const button = document.querySelector(`.student-number-btn[data-number="${number}"]`);
            
            if (index === -1) {
                selectedStudentNumbers.push(number);
                if (button) button.classList.add('bg-primary/20', 'border-primary');
            } else {
                selectedStudentNumbers.splice(index, 1);
                if (button) button.classList.remove('bg-primary/20', 'border-primary');
            }
            
            updateSelectedNumbersDisplay();
        }
        
        // 更新已选学号显示
        function updateSelectedNumbersDisplay() {
            const container = document.getElementById('selected-numbers');
            container.innerHTML = '';
            
            selectedStudentNumbers.sort((a, b) => a - b).forEach(number => {
                const tag = document.createElement('div');
                tag.className = 'inline-flex items-center glass-effect border border-white/30 bg-primary/20 text-primary px-3 py-1.5 rounded-full text-sm hover-lift transition-all duration-300';
                tag.innerHTML = `${number} <span class="ml-1 cursor-pointer remove-number">&times;</span>`;
                tag.dataset.number = number;
                
                const removeBtn = tag.querySelector('.remove-number');
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleStudentNumber(number);
                });
                
                container.appendChild(tag);
            });
            
            if (selectedStudentNumbers.length === 0) {
                container.innerHTML = '<span class="text-gray-400">暂无选择</span>';
            }
        }
        
        // 生成课程表
        function generateSchedule() {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';
            
            const courses = scheduleData[currentDay];
            courses.forEach(course => {
                container.appendChild(createCourseItem(course));
            });
        }
        
        // 创建课程节数编辑模态框
        function createSectionNumberModal(courseId) {
            // 移除已存在的模态框
            const existingModal = document.getElementById('section-number-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'section-number-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-md">
                    <div class="p-6 border-b border-white/20">
                        <h2 class="text-xl font-bold text-dark">修改课程节数</h2>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div>
                                <label for="section-number-input" class="block text-sm font-medium text-gray-700 mb-2">请输入新的课程节数</label>
                                <input 
                                    type="number" 
                                    id="section-number-input" 
                                    value="${courseId}"
                                    min="1"
                                    max="99"
                                    class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300"
                                    placeholder="1-99之间的数字"
                                >
                            </div>
                            <div class="flex gap-3">
                                <button id="section-number-cancel" class="flex-1 px-4 py-3 glass-effect border border-white/30 rounded-xl hover:bg-gray-200/20 transition-all duration-300">
                                    取消
                                </button>
                                <button id="section-number-confirm" class="flex-1 px-4 py-3 gradient-border bg-primary hover:bg-primary/90 text-white rounded-xl transition-all duration-300 hover:shadow-lg">
                                    确认
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 绑定事件
            const cancelBtn = document.getElementById('section-number-cancel');
            const confirmBtn = document.getElementById('section-number-confirm');
            const input = document.getElementById('section-number-input');
            
            // 自动聚焦输入框
            input.focus();
            input.select();
            
            // 取消按钮事件
            cancelBtn.addEventListener('click', () => {
                modal.remove();
            });
            
            // 确认按钮事件
            confirmBtn.addEventListener('click', () => {
                const number = parseInt(input.value);
                handleSectionNumberUpdate(courseId, number);
                modal.remove();
            });
            
            // 回车键确认
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const number = parseInt(input.value);
                    handleSectionNumberUpdate(courseId, number);
                    modal.remove();
                }
            });
        }
        
        // 处理课程节数更新
        function handleSectionNumberUpdate(courseId, number) {
            if (isNaN(number) || number < 1 || number > 99) {
                showToast('请输入有效的课程节数（1-99）！', 'error');
                return;
            }
            
            // 检查是否重复
            const courses = scheduleData[currentDay];
            if (courses.some(c => c.id !== courseId && c.id === number)) {
                showToast('该课程节数已存在！', 'error');
                return;
            }
            
            // 更新课程节数
            const courseIndex = courses.findIndex(c => c.id === courseId);
            if (courseIndex !== -1) {
                courses[courseIndex].id = number;
                
                // 按节数排序
                scheduleData[currentDay].sort((a, b) => a.id - b.id);
                
                saveScheduleData();
                generateSchedule();
                showToast('课程节数已更新！', 'success');
            }
        }
        
        // 编辑课程节数
        function editSectionNumber(courseId) {
            createSectionNumberModal(courseId);
        }
        
        // 创建课程项
        function createCourseItem(course) {
            const courseDiv = document.createElement('div');
            courseDiv.className = 'glass-effect rounded-xl p-5 shadow-sm border border-white/30 hover-lift transition-all duration-300 relative';
            courseDiv.innerHTML = `
                <div class="flex items-center mb-4">
                    <span class="section-number bg-primary/20 text-primary font-semibold rounded-full w-10 h-10 flex items-center justify-center mr-4 hover-lift transition-all duration-300 cursor-pointer" data-id="${course.id}" title="点击修改课程节数">${course.id}</span>
                    <input type="text" placeholder="请输入科目名称" value="${course.subject || ''}" 
                           class="flex-1 px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                           data-field="subject" data-id="${course.id}">
                </div>
                <button class="absolute top-4 right-4 text-gray-400 hover:text-danger transition-colors delete-course-btn" data-id="${course.id}">
                    <i class="fa fa-trash"></i>
                </button>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">课堂表现评分</label>
                    <!-- 快速选择科目 -->
                    <div class="flex flex-wrap gap-2 mb-2">
                        ${classConfig.subjects.map(subject => `
                            <button class="quick-subject-btn px-3 py-1 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-subject="${subject}">
                                ${subject}
                            </button>
                        `).join('')}
                    </div>
                    <!-- 评分显示，根据科目类型显示不同的评分方式 -->
                    <div class="space-y-3" data-field="rating" data-id="${course.id}">
                        ${course.subject === '数学' || course.subject === '英语' ? `
                            <!-- 分层班评分 - 三行显示 -->
                            <div class="flex items-center">
                                <span class="w-8 text-sm text-gray-500">1班:</span>
                                <div class="flex-1 flex gap-1">
                                    ${Array(5).fill(null).map((_, i) => {
                                        const starIndex = i + 1;
                                        return `<i class="fa fa-star text-sm cursor-pointer transition-transform hover:scale-110 ${starIndex <= (course.layerRatings?.layer1 || 0) ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}" data-layer="1"></i>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="w-8 text-sm text-gray-500">2班:</span>
                                <div class="flex-1 flex gap-1">
                                    ${Array(5).fill(null).map((_, i) => {
                                        const starIndex = i + 1;
                                        return `<i class="fa fa-star text-sm cursor-pointer transition-transform hover:scale-110 ${starIndex <= (course.layerRatings?.layer2 || 0) ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}" data-layer="2"></i>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="flex items-center">
                                <span class="w-8 text-sm text-gray-500">3班:</span>
                                <div class="flex-1 flex gap-1">
                                    ${Array(5).fill(null).map((_, i) => {
                                        const starIndex = i + 1;
                                        return `<i class="fa fa-star text-sm cursor-pointer transition-transform hover:scale-110 ${starIndex <= (course.layerRatings?.layer3 || 0) ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}" data-layer="3"></i>`;
                                    }).join('')}
                                </div>
                            </div>
                        ` : `
                            <!-- 普通评分 -->
                            <div class="flex gap-2">
                                ${Array(5).fill(null).map((_, i) => {
                                    const starIndex = i + 1;
                                    return `<i class="fa fa-star text-lg cursor-pointer transition-transform hover:scale-110 ${starIndex <= course.rating ? 'star-active' : 'star-inactive'}" data-rating="${starIndex}"></i>`;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
                
                <!-- 课堂不足及建议 - 根据科目类型显示不同 -->
                <div>
                    ${course.subject === '数学' || course.subject === '英语' ? `
                        <!-- 分层班的课堂不足及建议 -->
                        <label class="block text-sm font-medium text-gray-700 mb-2">课堂不足及建议</label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">1班：</label>
                                <textarea placeholder="请输入1班课堂不足及建议" rows="2" 
                                          class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                          data-field="notes" data-id="${course.id}" data-layer="1">${course.layerNotes?.layer1 || ''}</textarea>
                                <!-- 1班快速选择理由 -->
                                <div class="mt-2">
                                    <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="无" data-layer="1">无</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话" data-layer="1">上课说话</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉" data-layer="1">睡觉</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记" data-layer="1">不记笔记</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中" data-layer="1">注意力不集中</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序" data-layer="1">扰乱课堂秩序</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">2班：</label>
                                <textarea placeholder="请输入2班课堂不足及建议" rows="2" 
                                          class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                          data-field="notes" data-id="${course.id}" data-layer="2">${course.layerNotes?.layer2 || ''}</textarea>
                                <!-- 2班快速选择理由 -->
                                <div class="mt-2">
                                    <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="无" data-layer="2">无</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话" data-layer="2">上课说话</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉" data-layer="2">睡觉</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记" data-layer="2">不记笔记</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中" data-layer="2">注意力不集中</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序" data-layer="2">扰乱课堂秩序</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">3班：</label>
                                <textarea placeholder="请输入3班课堂不足及建议" rows="2" 
                                          class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                          data-field="notes" data-id="${course.id}" data-layer="3">${course.layerNotes?.layer3 || ''}</textarea>
                                <!-- 3班快速选择理由 -->
                                <div class="mt-2">
                                    <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="无" data-layer="3">无</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话" data-layer="3">上课说话</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉" data-layer="3">睡觉</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记" data-layer="3">不记笔记</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中" data-layer="3">注意力不集中</button>
                                        <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序" data-layer="3">扰乱课堂秩序</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <!-- 普通课堂不足及建议 -->
                        <label class="block text-sm font-medium text-gray-700 mb-2">课堂不足及建议</label>
                        <textarea placeholder="请输入课堂不足及建议" rows="2" 
                                  class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300" 
                                  data-field="notes" data-id="${course.id}">${course.notes || ''}</textarea>
                        <!-- 快速选择理由 -->
                        <div class="mt-2">
                            <label class="block text-xs text-gray-500 mb-1">快速选择理由：</label>
                            <div class="flex flex-wrap gap-2">
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="无">无</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="上课说话">上课说话</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="睡觉">睡觉</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="不记笔记">不记笔记</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="注意力不集中">注意力不集中</button>
                                <button class="quick-reason-btn px-2 py-0.5 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}" data-reason="扰乱课堂秩序">扰乱课堂秩序</button>
                            </div>
                        </div>
                    `}
                </div>
                
                <!-- 快速选择学号功能 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">表现不佳学生</label>
                    <div class="mb-2">
                        <div id="course-students-${course.id}" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto ios-scrollbar p-2 glass-effect border border-white/30 rounded-lg min-h-[60px]">
                            ${course.poorStudents ? course.poorStudents.map(num => `
                                <div class="inline-flex items-center glass-effect border border-white/30 bg-danger/20 text-danger px-2 py-1 rounded-full text-xs hover-lift transition-all duration-300">
                                    ${num} <span class="ml-1 cursor-pointer remove-poor-student" data-number="${num}">&times;</span>
                                </div>
                            `).join('') : '<span class="text-gray-400 text-xs">暂无选择</span>'}
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button class="quick-select-students-btn px-3 py-1 glass-effect border border-white/30 rounded-lg text-xs hover:bg-primary/10 transition-all duration-300" data-id="${course.id}">
                            <i class="fa fa-user-o mr-1"></i>选择学生
                        </button>
                    </div>
                </div>`;
            
            // 绑定科目输入事件
            const subjectInput = courseDiv.querySelector('[data-field="subject"]');
            subjectInput.addEventListener('input', function() {
                updateCourseData(course.id, 'subject', this.value);
            });
            
            // 绑定快速选择科目事件
            const quickSubjectBtns = courseDiv.querySelectorAll('.quick-subject-btn');
            quickSubjectBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const courseId = parseInt(this.dataset.id);
                    const subject = this.dataset.subject;
                    
                    // 更新科目
                    updateCourseData(courseId, 'subject', subject);
                    
                    // 更新UI中的科目输入框
                    const subjectInput = courseDiv.querySelector('[data-field="subject"]');
                    if (subjectInput) {
                        subjectInput.value = subject;
                    }
                    
                    // 添加点击动画效果
                    this.classList.add('bg-primary/20');
                    setTimeout(() => {
                        this.classList.remove('bg-primary/20');
                    }, 300);
                    
                    // 重新生成课程表以更新评分显示
                    setTimeout(() => {
                        generateSchedule();
                    }, 50);
                });
            });
            
            // 绑定评分点击事件
            const ratingContainer = courseDiv.querySelector('[data-field="rating"]');
            const stars = ratingContainer.querySelectorAll('.fa-star');
            stars.forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.dataset.rating);
                    
                    // 检查是否有分层信息
                    if (this.dataset.layer) {
                        // 分层评分逻辑
                        const layer = this.dataset.layer;
                        const courseId = parseInt(ratingContainer.dataset.id);
                        const course = scheduleData[currentDay].find(c => c.id === courseId);
                        
                        // 确保layerRatings对象存在
                        if (!course.layerRatings) {
                            course.layerRatings = { layer1: 0, layer2: 0, layer3: 0 };
                        }
                        
                        // 更新对应分层的评分
                        course.layerRatings[`layer${layer}`] = rating;
                        
                        // 保存数据
                        saveScheduleData();
                        
                        // 更新UI
                        generateSchedule();
                    } else {
                        // 普通评分逻辑
                        updateCourseData(course.id, 'rating', rating);
                        updateStarDisplay(stars, rating);
                    }
                    
                    // 添加点击动画效果
                    this.classList.add('animate-pulse');
                    setTimeout(() => {
                        this.classList.remove('animate-pulse');
                    }, 500);
                });
                
                // 添加悬停效果
                star.addEventListener('mouseenter', function() {
                    const rating = parseInt(this.dataset.rating);
                    
                    if (this.dataset.layer) {
                        // 分层评分悬停效果
                        const layer = this.dataset.layer;
                        const layerStars = ratingContainer.querySelectorAll(`[data-layer="${layer}"]`);
                        layerStars.forEach(s => {
                            const sRating = parseInt(s.dataset.rating);
                            if (sRating <= rating) {
                                s.classList.add('scale-125');
                            }
                        });
                    } else {
                        // 普通评分悬停效果
                        stars.forEach(s => {
                            const sRating = parseInt(s.dataset.rating);
                            if (sRating <= rating) {
                                s.classList.add('scale-125');
                            }
                        });
                    }
                });
                
                star.addEventListener('mouseleave', function() {
                    if (this.dataset.layer) {
                        // 分层评分恢复
                        const layer = this.dataset.layer;
                        const layerStars = ratingContainer.querySelectorAll(`[data-layer="${layer}"]`);
                        layerStars.forEach(s => {
                            s.classList.remove('scale-125');
                        });
                    } else {
                        // 普通评分恢复
                        stars.forEach(s => {
                            s.classList.remove('scale-125');
                        });
                    }
                });
            });
            
            // 绑定笔记输入事件 - 同时处理普通笔记和分层笔记
            const notesInputs = courseDiv.querySelectorAll('[data-field="notes"]');
            notesInputs.forEach(input => {
                input.addEventListener('input', function() {
                    const courseId = parseInt(this.dataset.id);
                    const layer = this.dataset.layer;
                    const course = scheduleData[currentDay].find(c => c.id === courseId);
                    
                    if (layer) {
                        // 分层笔记处理
                        if (!course.layerNotes) {
                            course.layerNotes = { layer1: '', layer2: '', layer3: '' };
                        }
                        course.layerNotes[`layer${layer}`] = this.value;
                        saveScheduleData();
                    } else {
                        // 普通笔记处理
                        updateCourseData(course.id, 'notes', this.value);
                    }
                });
            });
            
            // 绑定删除按钮事件
            const deleteBtn = courseDiv.querySelector('.delete-course-btn');
            deleteBtn.addEventListener('click', function() {
                const courseId = parseInt(this.dataset.id);
                deleteCourse(courseId);
            });
            
            // 绑定选择学生按钮事件
            const selectStudentsBtn = courseDiv.querySelector('.quick-select-students-btn');
            selectStudentsBtn.addEventListener('click', function() {
                const courseId = parseInt(this.dataset.id);
                showStudentSelectionModal(courseId);
            });
            
            // 绑定快速选择理由事件
            const quickReasonBtns = courseDiv.querySelectorAll('.quick-reason-btn');
            quickReasonBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const courseId = parseInt(this.dataset.id);
                    const reason = this.dataset.reason;
                    handleQuickReason(courseId, reason);
                });
            });
            
            // 绑定已选学生移除按钮事件
            const removeButtons = courseDiv.querySelectorAll('.remove-poor-student');
            removeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const number = parseInt(this.dataset.number);
                    removePoorStudent(course.id, number);
                });
            });
            
            // 绑定课程节数编辑事件
            const sectionNumberEl = courseDiv.querySelector('.section-number');
            sectionNumberEl.addEventListener('click', function() {
                const courseId = parseInt(this.dataset.id);
                editSectionNumber(courseId);
            });
            
            return courseDiv;
        }
        
        // 更新课程数据
        function updateCourseData(courseId, field, value) {
            const courseIndex = scheduleData[currentDay].findIndex(c => c.id === courseId);
            if (courseIndex !== -1) {
                scheduleData[currentDay][courseIndex][field] = value;
                // 自动保存到 IndexedDB
                saveScheduleData();
            }
        }
        
        // 更新表现不佳学生列表
        function updatePoorStudents(courseId, students) {
            const courseIndex = scheduleData[currentDay].findIndex(c => c.id === courseId);
            if (courseIndex !== -1) {
                scheduleData[currentDay][courseIndex].poorStudents = students;
                // 自动保存到 IndexedDB
                saveScheduleData();
            }
        }
        
        // 创建学生选择模态框
        function createStudentSelectionModal() {
            const modal = document.createElement('div');
            modal.id = 'student-selection-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b border-white/20">
                        <h2 class="text-2xl font-bold text-dark flex items-center gap-2">
                            <i class="fa fa-users text-primary"></i>
                            选择表现不佳学生
                        </h2>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">选择学号</label>
                            <div id="modal-student-numbers" class="flex flex-wrap gap-2 max-h-40 overflow-y-auto scrollbar-hide p-3 glass-effect border border-white/30 rounded-xl"></div>
                        </div>
                        
                        <!-- 已选学号列表 -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                已选择的学号
                                <span id="selected-count" class="ml-2 text-xs text-gray-500">(0)</span>
                            </label>
                            <div id="selected-students-list" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto scrollbar-hide p-3 glass-effect border border-primary/30 bg-primary/5 rounded-xl">
                                <span class="text-gray-400 text-sm">暂无选择</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 p-4 glass-effect border border-white/20 rounded-xl">
                            <button id="modal-select-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                                全选
                            </button>
                            <button id="modal-clear-all-btn" class="px-4 py-2 glass-effect border border-white/30 rounded-lg text-sm hover:bg-primary/10 transition-all duration-300">
                                清空选择
                            </button>
                        </div>
                    </div>
                    <div class="p-6 border-t border-white/20 flex justify-end gap-3">
                        <button id="modal-cancel" class="px-5 py-2.5 glass-effect border border-white/30 rounded-lg hover:bg-gray-100/50 transition-all duration-300">取消</button>
                        <button id="modal-confirm" class="px-5 py-2.5 gradient-border bg-primary hover:bg-primary/90 text-white rounded-lg transition-all duration-300 hover:shadow-lg">确认选择</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 更新已选学生列表
            function updateSelectedStudentsList(selectedStudents) {
                const listContainer = document.getElementById('selected-students-list');
                const countElement = document.getElementById('selected-count');
                
                // 确保元素存在
                if (!listContainer || !countElement) return;
                
                // 更新计数
                countElement.textContent = `(${selectedStudents.length})`;
                
                // 清空列表
                listContainer.innerHTML = '';
                
                if (selectedStudents.length === 0) {
                    // 如果没有选择学生，显示提示文本
                    const emptyText = document.createElement('span');
                    emptyText.className = 'text-gray-400 text-sm';
                    emptyText.textContent = '暂无选择';
                    listContainer.appendChild(emptyText);
                } else {
                    // 排序后显示选中的学生
                    const sortedStudents = [...selectedStudents].sort((a, b) => a - b);
                    sortedStudents.forEach(studentId => {
                        const tag = document.createElement('span');
                        tag.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary/20 text-primary';
                        tag.textContent = studentId;
                        
                        // 添加移除按钮
                        const removeBtn = document.createElement('button');
                        removeBtn.className = 'ml-1 text-primary hover:text-primary/70 focus:outline-none';
                        removeBtn.textContent = '×';
                        removeBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const modal = document.getElementById('student-selection-modal');
                            if (modal) {
                                const courseId = parseInt(modal.dataset.courseId);
                                const course = scheduleData[currentDay].find(c => c.id === courseId);
                                if (course) {
                                    // 从已选列表中移除该学生
                                    course.poorStudents = course.poorStudents.filter(id => id !== studentId);
                                    // 更新UI
                                    updateModalStudentButtons(course.poorStudents);
                                    updateSelectedStudentsList(course.poorStudents);
                                }
                            }
                        });
                        
                        tag.appendChild(removeBtn);
                        listContainer.appendChild(tag);
                    });
                }
            }
            
            // 显示学生选择模态框
        function showStudentSelectionModal(courseId) {
            let modal = document.getElementById('student-selection-modal');
            if (!modal) {
                createStudentSelectionModal();
                bindStudentSelectionModalEvents();
                // 重新获取创建后的模态框元素
                modal = document.getElementById('student-selection-modal');
            }
            
            // 确保模态框存在后再访问dataset
            if (modal) {
                // 保存当前课程ID
                modal.dataset.courseId = courseId;
            } else {
                console.error('无法创建或获取学生选择模态框');
                return;
            }
            
            // 获取当前课程的表现不佳学生列表
            const course = scheduleData[currentDay].find(c => c.id === courseId);
            const currentPoorStudents = course ? course.poorStudents : [];
            
            // 生成学号选择按钮
            const container = document.getElementById('modal-student-numbers');
            container.innerHTML = '';
            
            // 根据配置生成学号按钮
            for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                // 跳过排除的学号
                if (classConfig.excludedIds.includes(i)) continue;
                
                const button = document.createElement('button');
                button.className = 'student-number-btn w-10 h-10 flex items-center justify-center rounded-full glass-effect border border-white/30 hover:bg-primary/10 transition-all duration-300 hover-lift';
                button.textContent = i;
                button.dataset.number = i;
                
                // 如果已经在表现不佳学生列表中，标记为选中
                if (currentPoorStudents.includes(i)) {
                    button.classList.add('bg-primary/20', 'border-primary');
                }
                
                button.addEventListener('click', function() {
                    const number = parseInt(this.dataset.number);
                    const index = currentPoorStudents.indexOf(number);
                    
                    if (index === -1) {
                        currentPoorStudents.push(number);
                        this.classList.add('bg-primary/20', 'border-primary');
                    } else {
                        currentPoorStudents.splice(index, 1);
                        this.classList.remove('bg-primary/20', 'border-primary');
                    }
                    
                    // 更新已选学号列表
                    updateSelectedStudentsList(currentPoorStudents);
                });
                
                container.appendChild(button);
            }
            
            // 初始化已选学号列表
            updateSelectedStudentsList(currentPoorStudents);
            
            // 显示模态框
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭学生选择模态框
        function closeStudentSelectionModal() {
            const modal = document.getElementById('student-selection-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }
        
        // 绑定学生选择模态框事件
        function bindStudentSelectionModalEvents() {
            const modal = document.getElementById('student-selection-modal');
            if (!modal) return;
            
            // 取消按钮
            document.getElementById('modal-cancel').addEventListener('click', closeStudentSelectionModal);
            
            // 确认按钮
            document.getElementById('modal-confirm').addEventListener('click', function() {
                const courseId = parseInt(modal.dataset.courseId);
                const course = scheduleData[currentDay].find(c => c.id === courseId);
                
                if (course) {
                    // 更新课程的表现不佳学生列表
                    updatePoorStudents(courseId, course.poorStudents.sort((a, b) => a - b));
                    
                    // 更新UI显示
                    const container = document.getElementById(`course-students-${courseId}`);
                    if (container) {
                        if (course.poorStudents.length === 0) {
                            container.innerHTML = '<span class="text-gray-400 text-xs">暂无选择</span>';
                        } else {
                            container.innerHTML = course.poorStudents.map(num => `
                                <div class="inline-flex items-center glass-effect border border-white/30 bg-danger/20 text-danger px-2 py-1 rounded-full text-xs hover-lift transition-all duration-300">
                                    ${num} <span class="ml-1 cursor-pointer remove-poor-student" data-number="${num}" data-id="${courseId}">&times;</span>
                                </div>
                            `).join('');
                            
                            // 绑定移除按钮事件
                            container.querySelectorAll('.remove-poor-student').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const number = parseInt(this.dataset.number);
                                    const courseId = parseInt(this.dataset.id);
                                    removePoorStudent(courseId, number);
                                });
                            });
                        }
                    }
                }
                
                closeStudentSelectionModal();
            });
            
            // 模态框批量操作按钮
            document.getElementById('modal-select-all-btn').addEventListener('click', function() {
                const courseId = parseInt(modal.dataset.courseId);
                const course = scheduleData[currentDay].find(c => c.id === courseId);
                if (course) {
                    course.poorStudents = [];
                    
                    for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                        if (!classConfig.excludedIds.includes(i)) {
                            course.poorStudents.push(i);
                        }
                    }
                    
                    // 更新UI
                    updateModalStudentButtons(course.poorStudents);
                    updateSelectedStudentsList(course.poorStudents);
                }
            });
            
            // 移除范围选择功能
            
            document.getElementById('modal-clear-all-btn').addEventListener('click', function() {
                const courseId = parseInt(modal.dataset.courseId);
                const course = scheduleData[currentDay].find(c => c.id === courseId);
                if (course) {
                    course.poorStudents = [];
                    updateModalStudentButtons([]);
                    updateSelectedStudentsList([]);
                }
            });
            
            // 移除范围内的updateSelectedStudentsList函数定义
        }
        
        // 更新模态框中的学号按钮状态
        function updateModalStudentButtons(selectedNumbers) {
            document.querySelectorAll('#modal-student-numbers .student-number-btn').forEach(button => {
                const number = parseInt(button.dataset.number);
                if (selectedNumbers.includes(number)) {
                    button.classList.add('bg-primary/20', 'border-primary');
                } else {
                    button.classList.remove('bg-primary/20', 'border-primary');
                }
            });
        }
        
        // 移除表现不佳学生
        function removePoorStudent(courseId, number) {
            const course = scheduleData[currentDay].find(c => c.id === courseId);
            if (course) {
                const index = course.poorStudents.indexOf(number);
                if (index !== -1) {
                    course.poorStudents.splice(index, 1);
                    updatePoorStudents(courseId, course.poorStudents);
                    
                    // 更新UI
                    const container = document.getElementById(`course-students-${courseId}`);
                    if (container) {
                        if (course.poorStudents.length === 0) {
                            container.innerHTML = '<span class="text-gray-400 text-xs">暂无选择</span>';
                        } else {
                            container.innerHTML = course.poorStudents.map(num => `
                                <div class="inline-flex items-center glass-effect border border-white/30 bg-danger/20 text-danger px-2 py-1 rounded-full text-xs hover-lift transition-all duration-300">
                                    ${num} <span class="ml-1 cursor-pointer remove-poor-student" data-number="${num}" data-id="${courseId}">&times;</span>
                                </div>
                            `).join('');
                            
                            // 重新绑定移除按钮事件
                            container.querySelectorAll('.remove-poor-student').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const number = parseInt(this.dataset.number);
                                    const courseId = parseInt(this.dataset.id);
                                    removePoorStudent(courseId, number);
                                });
                            });
                        }
                    }
                }
            }
        }
        
        // 处理快速选择理由
        function handleQuickReason(courseId, reason) {
            // 获取触发事件的按钮，从中获取layer信息
            const event = window.event;
            const reasonBtn = event ? event.currentTarget : document.querySelector(`.quick-reason-btn[data-id="${courseId}"][data-reason="${reason}"]`);
            const layer = reasonBtn ? reasonBtn.dataset.layer : '1'; // 默认使用1班
            const layerKey = `layer${layer}`;
            
            const course = scheduleData[currentDay].find(c => c.id === courseId);
            if (course) {
                // 检查是否是分层科目（数学或英语）
                if (course.subject === '数学' || course.subject === '英语') {
                    // 分层科目 - 根据data-layer属性确定班级
                    if (!course.layerNotes) {
                        course.layerNotes = { layer1: '', layer2: '', layer3: '' };
                    }
                    
                    let newNote = course.layerNotes[layerKey] || '';
                    if (newNote) {
                        if (!newNote.includes(reason)) {
                            newNote += '，' + reason;
                        }
                    } else {
                        newNote = reason;
                    }
                    
                    course.layerNotes[layerKey] = newNote;
                    saveScheduleData();
                    
                    // 更新UI
                    const notesInput = document.querySelector(`textarea[data-field="notes"][data-id="${courseId}"][data-layer="${layer}"]`);
                    if (notesInput) {
                        notesInput.value = newNote;
                    }
                } else {
                    // 普通科目处理
                    let newNotes = course.notes || '';
                    if (newNotes) {
                        // 检查是否已经包含该理由
                        if (!newNotes.includes(reason)) {
                            newNotes += '，' + reason;
                        }
                    } else {
                        newNotes = reason;
                    }
                    
                    // 更新备注
                    updateCourseData(courseId, 'notes', newNotes);
                    
                    // 更新UI
                    const notesInput = document.querySelector(`textarea[data-field="notes"][data-id="${courseId}"]:not([data-layer])`);
                    if (notesInput) {
                        notesInput.value = newNotes;
                    }
                }
                
                // 添加点击动画效果
                if (reasonBtn) {
                    reasonBtn.classList.add('bg-primary/20');
                    setTimeout(() => {
                        reasonBtn.classList.remove('bg-primary/20');
                    }, 300);
                }
            }
        }
        
        // 更新星星显示
        function updateStarDisplay(stars, rating) {
            stars.forEach(star => {
                const starRating = parseInt(star.dataset.rating);
                if (starRating <= rating) {
                    star.classList.add('star-active');
                    star.classList.remove('star-inactive');
                } else {
                    star.classList.remove('star-active');
                    star.classList.add('star-inactive');
                }
            });
        }
        
        // 添加新课程
        function addNewCourse() {
            // 获取当前星期的课程数据
            const courses = scheduleData[currentDay];
            
            // 计算新课程的ID（当前最大ID + 1）
            const maxId = courses.length > 0 ? Math.max(...courses.map(c => c.id)) : 0;
            const newCourse = { id: maxId + 1, subject: '', rating: 0, notes: '' };
            
            // 添加新课程到数据中
            courses.push(newCourse);
            
            // 更新课程表显示
            generateSchedule();
            
            // 为了更好的用户体验，滚动到最后添加的课程
            const container = document.getElementById('schedule-container');
            container.scrollTop = container.scrollHeight;
            
            // 高亮显示新添加的课程（添加一个临时动画效果）
            setTimeout(() => {
                const newCourseElement = container.lastElementChild;
                if (newCourseElement) {
                    newCourseElement.classList.add('bg-primary/10');
                    setTimeout(() => {
                        newCourseElement.classList.remove('bg-primary/10');
                    }, 2000);
                }
            }, 100);
        }
        
        // 删除课程
        function deleteCourse(courseId) {
            // 创建自定义毛玻璃风格的确认弹窗
            const confirmationModal = document.createElement('div');
            confirmationModal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50';
            confirmationModal.innerHTML = `
                <div class="glass-effect rounded-xl p-6 max-w-md w-full border border-white/30 shadow-xl">
                    <h3 class="text-xl font-bold text-dark mb-4">确认删除</h3>
                    <p class="text-gray-700 mb-6">确定要删除这节课吗？</p>
                    <div class="flex gap-3 justify-end">
                        <button id="confirm-cancel" class="px-5 py-2.5 glass-effect border border-white/30 rounded-lg hover:bg-gray-100/50 transition-all duration-300">取消</button>
                        <button id="confirm-delete" class="px-5 py-2.5 gradient-border bg-danger hover:bg-danger/90 text-white rounded-lg transition-all duration-300 hover:shadow-lg">确认删除</button>
                    </div>
                </div>
            `;
            
            // 添加到文档中
            document.body.appendChild(confirmationModal);
            document.body.style.overflow = 'hidden';
            
            // 绑定取消按钮事件
            confirmationModal.querySelector('#confirm-cancel').addEventListener('click', function() {
                document.body.removeChild(confirmationModal);
                document.body.style.overflow = '';
            });
            
            // 绑定确认删除按钮事件
            confirmationModal.querySelector('#confirm-delete').addEventListener('click', function() {
                document.body.removeChild(confirmationModal);
                document.body.style.overflow = '';
                
                // 获取当前星期的课程数据
                const courses = scheduleData[currentDay];
                
                // 找到要删除的课程索引
                const courseIndex = courses.findIndex(c => c.id === courseId);
                
                if (courseIndex !== -1) {
                    // 获取要删除的元素进行动画效果
                    const container = document.getElementById('schedule-container');
                    const courseElements = container.querySelectorAll('.glass-effect.rounded-xl.p-5');
                    const elementToDelete = courseElements[courseIndex];
                    
                    if (elementToDelete) {
                        // 添加删除动画
                        elementToDelete.style.transition = 'all 0.3s ease';
                        elementToDelete.style.opacity = '0';
                        elementToDelete.style.transform = 'translateX(20px)';
                        elementToDelete.style.height = elementToDelete.offsetHeight + 'px';
                    }
                    
                    // 从数据中删除课程
                    setTimeout(() => {
                        courses.splice(courseIndex, 1);
                        
                        // 重新生成课程表
                        generateSchedule();
                    }, 300);
                }
            });
            
            // 添加点击外部关闭功能
            confirmationModal.addEventListener('click', function(e) {
                if (e.target === confirmationModal) {
                    document.body.removeChild(confirmationModal);
                    document.body.style.overflow = '';
                }
            });
        }
        
        // 绑定事件监听器
        function bindEventListeners() {
            // 星期切换按钮
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.day-btn').forEach(b => {
                        b.classList.remove('gradient-border', 'bg-primary', 'text-white');
                        b.classList.add('glass-effect', 'border', 'border-white/30', 'hover:bg-primary/10');
                    });
                    
                    this.classList.add('gradient-border', 'bg-primary', 'text-white');
                    this.classList.remove('glass-effect', 'border', 'border-white/30', 'hover:bg-primary/10');
                    
                    // 添加切换动画效果
                    const container = document.getElementById('schedule-container');
                    container.style.opacity = '0';
                    container.style.transform = 'translateY(20px)';
                    container.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    
                    setTimeout(() => {
                        generateSchedule();
                        container.style.opacity = '1';
                        container.style.transform = 'translateY(0)';
                    }, 150);
                    
                    currentDay = this.dataset.day;
                    generateSchedule();
                });
            });
            
            // 创建自定义科目模态框
            function createCustomSubjectModal() {
                const modal = document.createElement('div');
                modal.id = 'custom-subject-modal';
                modal.className = 'fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="glass-effect rounded-2xl w-full max-w-md p-6">
                        <div class="p-4 border-b border-white/20 mb-4">
                            <h2 class="text-xl font-bold text-dark">自定义科目</h2>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="custom-subject-input" class="block text-sm font-medium text-gray-700 mb-2">请输入科目名称</label>
                                <input 
                                    type="text" 
                                    id="custom-subject-input" 
                                    class="w-full px-4 py-3 glass-effect border border-white/30 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300"
                                    placeholder="例如：科技、综合实践等"
                                >
                            </div>
                            <div class="flex gap-3">
                                <button id="custom-subject-cancel" class="flex-1 px-4 py-3 glass-effect border border-white/30 rounded-xl hover:bg-gray-200/20 transition-all duration-300">
                                    取消
                                </button>
                                <button id="custom-subject-confirm" class="flex-1 px-4 py-3 gradient-border bg-primary hover:bg-primary/90 text-white rounded-xl transition-all duration-300 hover:shadow-lg">
                                    确认
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                // 添加事件监听
                document.getElementById('custom-subject-cancel').addEventListener('click', function() {
                    modal.classList.add('hidden');
                    document.getElementById('custom-subject-input').value = '';
                });
            }
            
            // 创建自定义科目模态框
            createCustomSubjectModal();
            
            // 添加未交作业记录
            document.getElementById('add-homework-record').addEventListener('click', function() {
                let subject = document.getElementById('selected-subject-text').textContent;
                
                // 检查是否已选择科目
                if (subject === '请选择科目') {
                    showToast('请先选择科目！', 'error');
                    return;
                }
                
                // 处理自定义科目
                if (subject === '自定义') {
                    // 显示毛玻璃模态框
                    const modal = document.getElementById('custom-subject-modal');
                    modal.classList.remove('hidden');
                    
                    // 保存当前选中的学生
                    const currentSelectedStudents = [...selectedStudentNumbers];
                    
                    // 重新绑定确认按钮事件，避免多次绑定
                    const confirmBtn = document.getElementById('custom-subject-confirm');
                    const newConfirmHandler = function() {
                        subject = document.getElementById('custom-subject-input').value;
                        if (!subject || subject.trim() === '') {
                            showToast('科目名称不能为空', 'error');
                            return;
                        }
                        
                        // 关闭模态框
                        modal.classList.add('hidden');
                        document.getElementById('custom-subject-input').value = '';
                        
                        // 移除事件监听器
                        confirmBtn.removeEventListener('click', newConfirmHandler);
                        
                        // 继续添加记录的逻辑
                        if (currentSelectedStudents.length === 0) {
                            showToast('请至少选择一名未交作业的学生', 'error');
                            return;
                        }
                        
                        const record = {
                            id: Date.now(),
                            subject: subject,
                            students: [...currentSelectedStudents],
                            date: new Date().toLocaleDateString('zh-CN')
                        };
                        
                        homeworkRecords.push(record);
                        displayHomeworkRecords();
                        // 保存到 IndexedDB
                        saveHomeworkRecords();
                        
                        // 清空选择
                        currentSelectedStudents.forEach(number => {
                            const button = document.querySelector(`.student-number-btn[data-number="${number}"]`);
                            if (button) button.classList.remove('bg-primary/20', 'border-primary');
                        });
                        selectedStudentNumbers = [];
                        updateSelectedNumbersDisplay();
                    };
                    
                    // 移除之前的事件监听器并添加新的
                    confirmBtn.removeEventListener('click', confirmBtn._lastHandler);
                    confirmBtn.addEventListener('click', newConfirmHandler);
                    confirmBtn._lastHandler = newConfirmHandler;
                    
                    // 防止默认提交
                    return false;
                }
                
                if (selectedStudentNumbers.length === 0) {
                    showToast('请至少选择一名未交作业的学生', 'error');
                    return;
                }
                
                const record = {
                    id: Date.now(),
                    subject: subject,
                    students: [...selectedStudentNumbers],
                    date: new Date().toLocaleDateString('zh-CN')
                };
                
                homeworkRecords.push(record);
                displayHomeworkRecords();
                // 保存到 IndexedDB
                saveHomeworkRecords();
                
                // 清空选择
                selectedStudentNumbers.forEach(number => {
                    const button = document.querySelector(`.student-number-btn[data-number="${number}"]`);
                    if (button) button.classList.remove('bg-primary/20', 'border-primary');
                });
                selectedStudentNumbers = [];
                updateSelectedNumbersDisplay();
            });
            
            // 导出Excel
            document.getElementById('export-excel').addEventListener('click', function() {
                // 添加点击动画效果
                this.classList.add('animate-pulse');
                setTimeout(() => {
                    this.classList.remove('animate-pulse');
                    exportToExcel();
                }, 300);
            });
            
            // 添加滚动时的视差效果
            window.addEventListener('scroll', function() {
                const scrollY = window.scrollY;
                const header = document.querySelector('header');
                header.style.transform = `translateY(${scrollY * 0.1}px)`;
            });
            
            // 添加新课按钮事件
            document.getElementById('add-new-course').addEventListener('click', function() {
                // 添加点击动画效果
                this.classList.add('animate-pulse');
                setTimeout(() => {
                    this.classList.remove('animate-pulse');
                    addNewCourse();
                }, 300);
            });
        }
        
        // 显示未交作业记录
        function displayHomeworkRecords() {
            const container = document.getElementById('homework-records');
            container.innerHTML = '';
            
            homeworkRecords.forEach(record => {
                const recordDiv = document.createElement('div');
                recordDiv.className = 'glass-effect p-4 rounded-xl shadow-sm border border-white/30 relative hover-lift transition-all duration-300';
                recordDiv.innerHTML = `
                    <div class="text-sm text-gray-500">${record.date}</div>
                    <div class="font-medium text-dark">${record.subject}</div>
                    <div class="text-sm">未交学号: ${record.students.sort((a, b) => a - b).join(', ')}</div>
                    <button class="absolute top-2 right-2 text-gray-400 hover:text-danger transition-colors delete-record" data-id="${record.id}">
                        <i class="fa fa-times"></i>
                    </button>
                `;
                
                const deleteBtn = recordDiv.querySelector('.delete-record');
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // 阻止事件冒泡到父元素
                    const recordId = parseInt(this.dataset.id);
                    // 从内存中移除记录
                    homeworkRecords = homeworkRecords.filter(r => r.id !== recordId);
                    
                    // 从IndexedDB中移除记录
                    if (db) {
                        const transaction = db.transaction(['homework'], 'readwrite');
                        const store = transaction.objectStore('homework');
                        store.delete(recordId);
                        
                        transaction.oncomplete = () => {
                            console.log('记录从数据库中删除成功');
                        };
                        
                        transaction.onerror = () => {
                            console.error('记录从数据库中删除失败');
                        };
                    }
                    
                    // 更新UI显示
                    displayHomeworkRecords();
                });
                
                // 添加点击事件以编辑学生名单
                recordDiv.addEventListener('click', function() {
                    const recordId = parseInt(this.querySelector('.delete-record').dataset.id);
                    openEditHomeworkModal(recordId);
                });
                
                container.appendChild(recordDiv);
            });
            
            if (homeworkRecords.length === 0) {
                container.innerHTML = '<div class="text-gray-400 text-center py-4">暂无记录</div>';
            }
        }
        
        // 创建编辑未交作业记录的模态框
        function createEditHomeworkModal() {
            // 确保模态框只创建一次
            let modal = document.getElementById('edit-homework-modal');
            if (modal) {
                return modal;
            }
            
            modal = document.createElement('div');
            modal.id = 'edit-homework-modal';
            modal.className = 'fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl w-full max-w-md">
                    <div class="p-6 border-b border-white/20">
                        <h2 class="text-xl font-bold text-dark">修改未交作业学生</h2>
                    </div>
                    <div class="p-6">
                        <div class="mb-4">
                            <div class="text-sm text-gray-500 mb-1" id="modal-record-date"></div>
                            <div class="font-medium text-dark mb-4" id="modal-record-subject"></div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">选择未交作业学生学号</label>
                            <div id="modal-student-selector" class="flex flex-wrap gap-2 max-h-64 overflow-y-auto scrollbar-hide p-3 glass-effect border border-white/30 rounded-xl"></div>
                        </div>
                        <div class="flex gap-3">
                            <button id="modal-cancel-edit" class="flex-1 px-4 py-3 glass-effect border border-white/30 rounded-xl hover:bg-gray-200/20 transition-all duration-300">
                                取消
                            </button>
                            <button id="modal-confirm-edit" class="flex-1 px-4 py-3 gradient-border bg-primary hover:bg-primary/90 text-white rounded-xl transition-all duration-300 hover:shadow-lg">
                                确认修改
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // 添加关闭事件
            document.getElementById('modal-cancel-edit').addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            // 确认修改事件
            document.getElementById('modal-confirm-edit').addEventListener('click', function() {
                const recordId = parseInt(modal.dataset.recordId);
                const selectedStudents = Array.from(document.querySelectorAll('#modal-student-selector .student-number-btn'))
                    .filter(btn => btn.classList.contains('selected'))
                    .map(btn => parseInt(btn.dataset.number));
                
                if (selectedStudents.length === 0) {
                    showToast('请至少选择一名未交作业的学生', 'error');
                    return;
                }
                
                // 更新内存中的记录
                const recordIndex = homeworkRecords.findIndex(r => r.id === recordId);
                if (recordIndex !== -1) {
                    homeworkRecords[recordIndex].students = [...selectedStudents];
                    
                    // 更新IndexedDB
                    if (db) {
                        const transaction = db.transaction(['homework'], 'readwrite');
                        const store = transaction.objectStore('homework');
                        store.put(homeworkRecords[recordIndex]);
                        
                        transaction.oncomplete = () => {
                            console.log('记录更新成功');
                        };
                        
                        transaction.onerror = () => {
                            console.error('记录更新失败');
                        };
                    }
                    
                    // 更新UI
                    displayHomeworkRecords();
                    showToast('修改成功', 'success');
                }
                
                // 关闭模态框
                modal.classList.add('hidden');
            });
            
            return modal;
        }
        
        // 打开编辑未交作业记录模态框
        function openEditHomeworkModal(recordId) {
            // 获取或创建模态框
            const modal = createEditHomeworkModal();
            
            // 保存当前记录ID
            modal.dataset.recordId = recordId;
            
            // 获取记录数据
            const record = homeworkRecords.find(r => r.id === recordId);
            if (record) {
                // 设置记录信息
                document.getElementById('modal-record-date').textContent = record.date;
                document.getElementById('modal-record-subject').textContent = record.subject;
                
                // 生成学号选择按钮
                const container = document.getElementById('modal-student-selector');
                container.innerHTML = '';
                
                // 添加选中样式的CSS（确保每次打开模态框时都应用）
                if (!document.querySelector('#edit-homework-modal-style')) {
                    const style = document.createElement('style');
                    style.id = 'edit-homework-modal-style';
                    style.textContent = `
                        .student-number-btn.selected {
                            background-color: rgba(59, 130, 246, 0.2); /* primary color with 20% opacity */
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // 创建一个函数来处理按钮点击
                function handleButtonClick() {
                    if (this.classList.contains('selected')) {
                        // 取消选择
                        this.classList.remove('selected');
                        this.classList.remove('border-primary');
                        this.dataset.selected = 'false';
                    } else {
                        // 选择
                        this.classList.add('selected', 'border-primary');
                        this.dataset.selected = 'true';
                    }
                }
                
                // 根据配置生成学号按钮
                for (let i = classConfig.minStudentId; i <= classConfig.maxStudentId; i++) {
                    // 跳过排除的学号
                    if (classConfig.excludedIds.includes(i)) continue;
                    
                    const button = document.createElement('button');
                    // 使用自定义数据属性来标记选中状态，避免CSS选择器中的斜杠问题
                    button.className = `student-number-btn w-10 h-10 flex items-center justify-center rounded-full glass-effect border border-white/30 hover:bg-primary/10 transition-all duration-300 hover-lift ${record.students.includes(i) ? 'selected' : ''}`;
                    button.dataset.selected = record.students.includes(i) ? 'true' : 'false';
                    button.textContent = i;
                    button.dataset.number = i;
                    
                    // 添加点击事件
                    button.addEventListener('click', handleButtonClick);
                    
                    container.appendChild(button);
                }
                
                // 显示模态框
                modal.classList.remove('hidden');
            }
        }
        
        // 导出Excel
        function exportToExcel() {
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            
            // 定义样式
            const styles = {
                header: {
                    font: { bold: true, sz: 12, color: { rgb: "000000" } },
                    fill: { type: "pattern", patternType: "solid", fgColor: { rgb: "CCCCCC" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                },
                cell: {
                    font: { sz: 11, color: { rgb: "000000" } },
                    alignment: { horizontal: "left", vertical: "top", wrapText: true },
                    border: {
                        top: { style: "thin", color: { rgb: "DDDDDD" } },
                        bottom: { style: "thin", color: { rgb: "DDDDDD" } },
                        left: { style: "thin", color: { rgb: "DDDDDD" } },
                        right: { style: "thin", color: { rgb: "DDDDDD" } }
                    }
                },
                numberCell: {
                    font: { sz: 11, color: { rgb: "000000" } },
                    alignment: { horizontal: "right", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "DDDDDD" } },
                        bottom: { style: "thin", color: { rgb: "DDDDDD" } },
                        left: { style: "thin", color: { rgb: "DDDDDD" } },
                        right: { style: "thin", color: { rgb: "DDDDDD" } }
                    }
                }
            };
            
            // 准备课程数据 - 每天一列的格式
            // 获取最大课时数
            // 只包含工作日（周一到周五），不包含周六和周日
            const daysOfWeek = ["周一", "周二", "周三", "周四", "周五"];
            let maxCourseId = 0;
            daysOfWeek.forEach(day => {
                if (scheduleData[day]) {
                    scheduleData[day].forEach(course => {
                        if (course.id > maxCourseId) {
                            maxCourseId = course.id;
                        }
                    });
                }
            });
            
            // 创建二维数组表示表格
            // 第一行为标题行
            const scheduleSheetData = [['课时']];
            
            // 添加星期作为列标题
            daysOfWeek.forEach(day => {
                scheduleSheetData[0].push(day);
            });
            
            // 为每个课时创建一行
            for (let courseId = 1; courseId <= maxCourseId; courseId++) {
                const row = [courseId];
                
                // 为每天添加对应的课程信息
                daysOfWeek.forEach(day => {
                    const course = scheduleData[day]?.find(c => c.id === courseId);
                    if (course && course.subject) {
                        // 检查是否是分层科目（数学或英语）
                        if (course.subject === '数学' || course.subject === '英语') {
                            // 分层科目处理
                            let content = '';
                            for (let layer = 1; layer <= 3; layer++) {
                                const layerKey = `layer${layer}`;
                                const layerRating = course.layerRatings?.[layerKey] || 0;
                                const layerNotes = course.layerNotes?.[layerKey] || '';
                                
                                if (layerRating > 0 || layerNotes) {
                                    content += `${course.subject}(${layer}班)\n评分: ${layerRating}\n`;
                                    if (layerNotes) {
                                        content += `建议: ${layerNotes}\n`;
                                    }
                                }
                            }
                            // 添加表现不佳的学生
                            if (course.poorStudents && course.poorStudents.length > 0) {
                                content += `不佳学生: ${course.poorStudents.join(', ')}`;
                            }
                            row.push(content.trim() || course.subject);
                        } else {
                            // 普通科目
                            let content = `${course.subject}\n评分: ${course.rating}\n`;
                            if (course.notes) {
                                content += `建议: ${course.notes}\n`;
                            }
                            if (course.poorStudents && course.poorStudents.length > 0) {
                                content += `不佳学生: ${course.poorStudents.join(', ')}`;
                            }
                            row.push(content.trim());
                        }
                    } else {
                        row.push(''); // 空单元格
                    }
                });
                
                scheduleSheetData.push(row);
            }
            
            // 准备未交作业数据（保持原有格式）
            const homeworkDataForExcel = [];
            homeworkRecords.forEach(record => {
                record.students.forEach(student => {
                    homeworkDataForExcel.push({
                        '日期': record.date,
                        '科目': record.subject,
                        '未交学号': student
                    });
                });
            });
            
            // 创建工作表
            // 课程表现表使用二维数组直接创建
            if (scheduleSheetData.length > 1) { // 确保有数据行
                const wsSchedule = XLSX.utils.aoa_to_sheet(scheduleSheetData);
                
                // 设置单元格样式和列宽
                // 为表头设置样式
                const range = XLSX.utils.decode_range(wsSchedule['!ref']);
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    // 表头单元格样式
                    const address = XLSX.utils.encode_cell({c: C, r: 0});
                    wsSchedule[address].s = styles.header;
                    
                    // 课时列使用数字对齐
                    if (C === 0) {
                        for (let R = 1; R <= range.e.r; ++R) {
                            const cellAddress = XLSX.utils.encode_cell({c: C, r: R});
                            if (wsSchedule[cellAddress]) {
                                wsSchedule[cellAddress].s = styles.numberCell;
                            }
                        }
                        // 设置课时列宽
                        wsSchedule['!cols'] = wsSchedule['!cols'] || [];
                        wsSchedule['!cols'][0] = {wch: 6};
                    } else {
                        // 其他列使用文本对齐
                        for (let R = 1; R <= range.e.r; ++R) {
                            const cellAddress = XLSX.utils.encode_cell({c: C, r: R});
                            if (wsSchedule[cellAddress]) {
                                wsSchedule[cellAddress].s = styles.cell;
                            }
                        }
                        // 设置其他列宽
                        wsSchedule['!cols'] = wsSchedule['!cols'] || [];
                        wsSchedule['!cols'][C] = {wch: 30}; // 课程内容列宽
                    }
                }
                
                // 设置行高
                wsSchedule['!rows'] = [];
                for (let R = 0; R <= range.e.r; ++R) {
                    if (R === 0) {
                        // 表头行高
                        wsSchedule['!rows'][R] = {hpt: 30};
                    } else {
                        // 数据行高 - 考虑多行文本
                        wsSchedule['!rows'][R] = {hpt: 60};
                    }
                }
                
                XLSX.utils.book_append_sheet(wb, wsSchedule, '课程表现');
            }
            
            if (homeworkDataForExcel.length > 0) {
                const wsHomework = XLSX.utils.json_to_sheet(homeworkDataForExcel);
                
                // 设置单元格样式和列宽
                const range = XLSX.utils.decode_range(wsHomework['!ref']);
                
                // 为表头设置样式
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({c: C, r: 0});
                    wsHomework[address].s = styles.header;
                }
                
                // 为数据单元格设置样式
                for (let R = 1; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const address = XLSX.utils.encode_cell({c: C, r: R});
                        if (wsHomework[address]) {
                            // 学号列使用数字对齐
                            if (C === 2) { // 未交学号列
                                wsHomework[address].s = styles.numberCell;
                            } else { // 其他列使用文本对齐
                                wsHomework[address].s = styles.cell;
                            }
                        }
                    }
                }
                
                // 设置列宽
                wsHomework['!cols'] = [
                    {wch: 12}, // 日期列宽
                    {wch: 10}, // 科目列宽
                    {wch: 10}  // 学号列宽
                ];
                
                // 设置行高
                wsHomework['!rows'] = [];
                for (let R = 0; R <= range.e.r; ++R) {
                    wsHomework['!rows'][R] = {hpt: 25};
                }
                
                XLSX.utils.book_append_sheet(wb, wsHomework, '未交作业记录');
            }
            
            // 设置工作簿属性
            wb.Props = {
                Title: "班级统计报告",
                Subject: "班级学情统计",
                Author: "班级学情统计系统",
                CreatedDate: new Date()
            };
            
            // 导出文件
            const dateStr = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `班级统计_${dateStr}.xlsx`);
            showToast('Excel导出成功', 'success');
        }
    </script>
</body>
</html>

